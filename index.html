<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GymTracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="manifest"
    href="data:application/json;base64,eyJuYW1lIjoiR3ltVHJhY2tlciIsInNob3J0X25hbWUiOiJHeW1UcmFja2VyIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkY1RjAiLCJ0aGVtZV9jb2xvciI6IiNGRjZCNkIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyM0ZGNkI2QicvJTNFJTNDdGV4dCB4PScyNSUyNScgeT0nNjUlMjUnIGZvbnQtc2l6ZT0nNjAnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nQXJpYWwlMkNzYW5zLXNlcmlmJyUzRUclM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const SUPABASE_URL = 'https://wvogkaailuwqojhljhmv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2b2drYWFpbHV3cW9qaGxqaG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTEwNzksImV4cCI6MjA4NDE2NzA3OX0.PfUsBawk-x3FWZL0BAe-_tRyveMUQor1bbYly5qIfQM';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const { useState, useEffect, useRef } = React;

    // Lucide Icons as React components
    const Icon = ({ name, size = 20, className = '' }) => {
      const icons = {
        'clipboard-list': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
        'dumbbell': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.4 14.4 9.6 9.6"/><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"/><path d="m21.5 21.5-1.4-1.4"/><path d="M3.9 3.9 2.5 2.5"/><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"/></svg>,
        'bar-chart': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
        'user': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        'activity': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>,
        'flame': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
        'clock': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        'plus': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        'trash': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
        'edit': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
        'check': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
        'x': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
        'chevron-left': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
        'chevron-right': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
        'ruler': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>,
        'scale': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
        'log-out': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
        'play': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>,
        'trophy': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
        'calendar': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>,
        'loader': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>,
        'target': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        'zap': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>,
        'timer': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>,
        'arrow-up': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>,
        'arrow-down': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
        'history': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
        'file-text': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
        'weight': <svg className={`icon ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="5" r="3"/><path d="M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z"/></svg>,
      };
      return icons[name] || null;
    };

    // Supabase utilities
    const db = {
      // Programmes
      async getPrograms(userId) {
        const { data, error } = await supabase
          .from('programs')
          .select(`
            *,
            sessions (
              *,
              exercises (*)
            )
          `)
          .eq('user_id', userId)
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error fetching programs:', error);
          return [];
        }

        return data.map(p => ({
          id: p.id,
          name: p.name,
          createdAt: new Date(p.created_at).getTime(),
          sessions: (p.sessions || []).map(s => ({
            id: s.id,
            name: s.name,
            exercises: (s.exercises || [])
              .sort((a, b) => (a.position ?? 0) - (b.position ?? 0))
              .map(e => ({
                id: e.id,
                name: e.name,
                sets: e.sets,
                restTime: e.rest_time,
                notes: e.notes,
                position: e.position ?? 0
              }))
          }))
        }));
      },

      async addProgram(userId, name) {
        const { data, error } = await supabase
          .from('programs')
          .insert({ user_id: userId, name })
          .select()
          .single();

        if (error) throw error;
        return data;
      },

      async deleteProgram(programId) {
        const { error } = await supabase
          .from('programs')
          .delete()
          .eq('id', programId);

        if (error) throw error;
      },

      async addSession(programId, name) {
        const { data, error } = await supabase
          .from('sessions')
          .insert({ program_id: programId, name })
          .select()
          .single();

        if (error) throw error;
        return data;
      },

      async deleteSession(sessionId) {
        const { error } = await supabase
          .from('sessions')
          .delete()
          .eq('id', sessionId);

        if (error) throw error;
      },

      async addExercise(sessionId, exerciseData) {
        // Calculer la prochaine position
        const { data: existingExercises } = await supabase
          .from('exercises')
          .select('position')
          .eq('session_id', sessionId)
          .order('position', { ascending: false })
          .limit(1);

        const nextPosition = existingExercises?.length > 0
          ? existingExercises[0].position + 1
          : 0;

        const { data, error } = await supabase
          .from('exercises')
          .insert({
            session_id: sessionId,
            name: exerciseData.name,
            sets: exerciseData.sets,
            rest_time: exerciseData.restTime,
            notes: exerciseData.notes,
            position: nextPosition
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      },

      async updateExercise(exerciseId, exerciseData) {
        const { error } = await supabase
          .from('exercises')
          .update({
            name: exerciseData.name,
            sets: exerciseData.sets,
            rest_time: exerciseData.restTime,
            notes: exerciseData.notes
          })
          .eq('id', exerciseId);

        if (error) throw error;
      },

      async deleteExercise(exerciseId) {
        const { error } = await supabase
          .from('exercises')
          .delete()
          .eq('id', exerciseId);

        if (error) throw error;
      },

      async reorderExercises(exerciseIds) {
        // Met à jour les positions de tous les exercices
        // exerciseIds est un tableau d'IDs dans le nouvel ordre
        for (let i = 0; i < exerciseIds.length; i++) {
          const { error } = await supabase
            .from('exercises')
            .update({ position: i })
            .eq('id', exerciseIds[i]);

          if (error) throw error;
        }
      },

      // Workout History
      async getWorkoutHistory(userId) {
        const { data, error } = await supabase
          .from('workout_history')
          .select('*')
          .eq('user_id', userId)
          .order('completed_at', { ascending: false });

        if (error) {
          console.error('Error fetching history:', error);
          return [];
        }

        return data.map(w => ({
          id: w.id,
          programId: w.program_id,
          programName: w.program_name,
          sessionId: w.session_id,
          sessionName: w.session_name,
          exercises: w.exercises,
          startedAt: new Date(w.started_at).getTime(),
          completedAt: new Date(w.completed_at).getTime(),
          duration: w.duration
        }));
      },

      async addWorkoutHistory(userId, workout) {
        const { error } = await supabase
          .from('workout_history')
          .insert({
            user_id: userId,
            program_id: workout.programId,
            program_name: workout.programName,
            session_id: workout.sessionId,
            session_name: workout.sessionName,
            exercises: workout.exercises,
            started_at: new Date(workout.startedAt).toISOString(),
            completed_at: new Date(workout.completedAt).toISOString(),
            duration: workout.duration
          });

        if (error) throw error;
      },

      async deleteWorkout(workoutId) {
        const { error } = await supabase
          .from('workout_history')
          .delete()
          .eq('id', workoutId);

        if (error) throw error;
      },

      async updateWorkout(workoutId, exercises) {
        const { error } = await supabase
          .from('workout_history')
          .update({ exercises })
          .eq('id', workoutId);

        if (error) throw error;
      },

      // Profiles
      async getProfile(userId) {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.error('Error fetching profile:', error);
          return null;
        }

        return data;
      },

      async updateProfile(userId, profileData) {
        const { error } = await supabase
          .from('profiles')
          .update({
            first_name: profileData.firstName,
            last_name: profileData.lastName,
            height: profileData.height,
            weight: profileData.weight
          })
          .eq('id', userId);

        if (error) throw error;
      },

      // Stats pour la semaine courante
      async getWeekStats(userId) {
        // Calculer le début de la semaine (lundi)
        const now = new Date();
        const dayOfWeek = now.getDay();
        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Ajuster pour que lundi = 0
        const monday = new Date(now);
        monday.setDate(now.getDate() - diff);
        monday.setHours(0, 0, 0, 0);

        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23, 59, 59, 999);

        const { data, error } = await supabase
          .from('workout_history')
          .select('*')
          .eq('user_id', userId)
          .gte('completed_at', monday.toISOString())
          .lte('completed_at', sunday.toISOString());

        if (error) {
          console.error('Error fetching week stats:', error);
          return { workouts: 0, volume: 0, duration: 0 };
        }

        let totalVolume = 0;
        let totalDuration = 0;

        data.forEach(workout => {
          totalDuration += workout.duration || 0;
          workout.exercises?.forEach(exercise => {
            exercise.sets?.forEach(set => {
              if (set.completed) {
                const weight = parseFloat(set.weight) || 0;
                const reps = parseInt(set.reps) || 0;
                totalVolume += weight * reps;
              }
            });
          });
        });

        return {
          workouts: data.length,
          volume: Math.round(totalVolume),
          duration: totalDuration
        };
      },

      // Stats des 5 dernières semaines pour le graphique
      async getWeeklyWorkouts(userId) {
        const weeks = [];
        const now = new Date();

        // Calculer le début de la semaine courante (lundi)
        const dayOfWeek = now.getDay();
        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        const currentMonday = new Date(now);
        currentMonday.setDate(now.getDate() - diff);
        currentMonday.setHours(0, 0, 0, 0);

        // Générer les 5 semaines (semaine courante + 4 précédentes)
        for (let i = 4; i >= 0; i--) {
          const weekStart = new Date(currentMonday);
          weekStart.setDate(currentMonday.getDate() - (i * 7));

          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          weekEnd.setHours(23, 59, 59, 999);

          // Format du label: "14-20 Jan" ou "S42"
          const startDay = weekStart.getDate();
          const endDay = weekEnd.getDate();
          const month = weekStart.toLocaleDateString('fr-FR', { month: 'short' });
          const label = `${startDay}-${endDay} ${month}`;

          weeks.push({
            start: weekStart.toISOString(),
            end: weekEnd.toISOString(),
            label
          });
        }

        // Récupérer tous les workouts des 5 dernières semaines
        const { data, error } = await supabase
          .from('workout_history')
          .select('completed_at')
          .eq('user_id', userId)
          .gte('completed_at', weeks[0].start)
          .lte('completed_at', weeks[4].end);

        if (error) {
          console.error('Error fetching weekly workouts:', error);
          return weeks.map(w => ({ ...w, count: 0 }));
        }

        // Compter les workouts par semaine
        return weeks.map(week => {
          const count = data.filter(workout => {
            const completedAt = new Date(workout.completed_at);
            return completedAt >= new Date(week.start) && completedAt <= new Date(week.end);
          }).length;
          return { ...week, count };
        });
      }
    };

    // Auth utilities
    const auth = {
      async signUp(email, password) {
        const { data, error } = await supabase.auth.signUp({
          email,
          password
        });

        if (error) throw error;
        return data;
      },

      async signIn(email, password) {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;
        return data;
      },

      async signOut() {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
      },

      async getUser() {
        const { data: { user } } = await supabase.auth.getUser();
        return user;
      },

      onAuthStateChange(callback) {
        return supabase.auth.onAuthStateChange(callback);
      }
    };

    // Generate unique ID
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    // Format date
    const formatDate = (timestamp) => {
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return `Aujourd'hui à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else if (date.toDateString() === yesterday.toDateString()) {
        return `Hier à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    };

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState(() => {
        // Si un entraînement est en cours, afficher la vue workout
        try {
          const saved = localStorage.getItem('gymtracker_active_workout');
          return saved ? 'workout' : 'programs';
        } catch (e) {
          return 'programs';
        }
      });
      const [programs, setPrograms] = useState([]);
      const [workoutHistory, setWorkoutHistory] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [modalType, setModalType] = useState('');
      const [currentProgram, setCurrentProgram] = useState(null);
      const [currentSession, setCurrentSession] = useState(null);
      const [currentExercise, setCurrentExercise] = useState(null);
      const [currentWorkout, setCurrentWorkout] = useState(null);
      const [activeWorkout, setActiveWorkout] = useState(() => {
        // Charger l'entraînement en cours depuis localStorage au démarrage
        try {
          const saved = localStorage.getItem('gymtracker_active_workout');
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          return null;
        }
      });

      // Sauvegarder l'entraînement en cours dans localStorage à chaque modification
      useEffect(() => {
        if (activeWorkout) {
          localStorage.setItem('gymtracker_active_workout', JSON.stringify(activeWorkout));
        } else {
          localStorage.removeItem('gymtracker_active_workout');
        }
      }, [activeWorkout]);

      // Check auth on mount
      useEffect(() => {
        auth.getUser().then(user => {
          setUser(user);
          setLoading(false);
        });

        const { data: subscription } = auth.onAuthStateChange((event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription?.subscription?.unsubscribe();
      }, []);

      // Load data when user changes
      useEffect(() => {
        if (user) {
          loadData();
        } else {
          setPrograms([]);
          setWorkoutHistory([]);
        }
      }, [user]);

      const loadData = async () => {
        if (!user) return;

        try {
          const [programsData, historyData] = await Promise.all([
            db.getPrograms(user.id),
            db.getWorkoutHistory(user.id)
          ]);

          setPrograms(programsData);
          setWorkoutHistory(historyData);
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Erreur lors du chargement des données');
        }
      };

      const openModal = (type, program = null, session = null, exercise = null, workout = null) => {
        setModalType(type);
        setCurrentProgram(program);
        setCurrentSession(session);
        setCurrentExercise(exercise);
        setCurrentWorkout(workout);
        setShowModal(true);
      };

      const closeModal = () => {
        setShowModal(false);
        setModalType('');
        setCurrentProgram(null);
        setCurrentSession(null);
        setCurrentExercise(null);
        setCurrentWorkout(null);
      };

      const addProgram = async (name) => {
        try {
          await db.addProgram(user.id, name);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la création du programme');
        }
      };

      const deleteProgram = async (programId) => {
        if (confirm('Supprimer ce programme ?')) {
          try {
            await db.deleteProgram(programId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const addSession = async (programId, name) => {
        try {
          await db.addSession(programId, name);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la création de la séance');
        }
      };

      const deleteSession = async (programId, sessionId) => {
        if (confirm('Supprimer cette séance ?')) {
          try {
            await db.deleteSession(sessionId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const addExercise = async (programId, sessionId, exerciseData) => {
        try {
          await db.addExercise(sessionId, exerciseData);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la création de l\'exercice');
        }
      };

      const editExercise = async (programId, sessionId, exerciseId, exerciseData) => {
        try {
          await db.updateExercise(exerciseId, exerciseData);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la modification');
        }
      };

      const deleteExercise = async (programId, sessionId, exerciseId) => {
        if (confirm('Supprimer cet exercice ?')) {
          try {
            await db.deleteExercise(exerciseId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const reorderExercises = async (sessionId, exerciseIds) => {
        try {
          await db.reorderExercises(exerciseIds);
          await loadData();
        } catch (error) {
          console.error('Error reordering exercises:', error);
          alert('Erreur lors de la réorganisation des exercices');
        }
      };

      const startWorkout = (program, session) => {
        const workout = {
          program,
          session,
          exercises: session.exercises.map(ex => ({
            ...ex,
            sets: Array(ex.sets).fill(null).map(() => ({
              reps: '',
              weight: '',
              completed: false
            }))
          })),
          startedAt: Date.now()
        };
        setActiveWorkout(workout);
        setView('workout');
      };

      const endWorkout = async (workout) => {
        const completedWorkout = {
          programId: workout.program.id,
          programName: workout.program.name,
          sessionId: workout.session.id,
          sessionName: workout.session.name,
          exercises: workout.exercises,
          startedAt: workout.startedAt,
          completedAt: Date.now(),
          duration: calculateDuration(workout.startedAt, Date.now())
        };

        try {
          await db.addWorkoutHistory(user.id, completedWorkout);
        } catch (error) {
          console.error('Error saving workout:', error);
          alert('Erreur lors de la sauvegarde de l\'entraînement');
          return;
        }

        // Toujours revenir à l'écran principal, même si loadData échoue
        setActiveWorkout(null);
        setView('programs');

        try {
          await loadData();
        } catch (error) {
          console.error('Error reloading data:', error);
        }
      };

      const discardWorkout = () => {
        setActiveWorkout(null);
        setView('programs');
      };

      const deleteWorkout = async (workoutId) => {
        if (confirm('Supprimer cette séance de l\'historique ?')) {
          try {
            await db.deleteWorkout(workoutId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const deleteHistoryExercise = async (workoutId, exerciseId) => {
        if (confirm('Supprimer cet exercice de l\'historique ?')) {
          try {
            const workout = workoutHistory.find(w => w.id === workoutId);
            const updatedExercises = workout.exercises.filter(e => e.id !== exerciseId);
            await db.updateWorkout(workoutId, updatedExercises);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const editHistoryExercise = async (workoutId, exerciseId, updatedSets) => {
        try {
          const workout = workoutHistory.find(w => w.id === workoutId);
          const updatedExercises = workout.exercises.map(e =>
            e.id === exerciseId ? { ...e, sets: updatedSets } : e
          );
          await db.updateWorkout(workoutId, updatedExercises);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la modification');
        }
      };

      if (loading) {
        return (
          <div className="app">
            <div className="empty-state">
              <div className="empty-icon"><Icon name="loader" size={48} /></div>
              <div className="empty-text">Chargement...</div>
            </div>
          </div>
        );
      }

      if (!user) {
        return <AuthScreen />;
      }

      return (
        <div className="app">
          <header className="header">
            <h1>GymTracker</h1>
            <div className="header-subtitle"><Icon name="target" size={14} /> Ton coach personnel</div>
          </header>

          <div className="content">
            {view === 'programs' && (
              <ProgramsView
                programs={programs}
                onAddProgram={() => openModal('program')}
                onDeleteProgram={deleteProgram}
                onAddSession={(program) => openModal('session', program)}
                onDeleteSession={deleteSession}
                onAddExercise={(program, session) => openModal('exercise', program, session)}
                onEditExercise={(program, session, exercise) => openModal('edit-exercise', program, session, exercise)}
                onDeleteExercise={deleteExercise}
                onReorderExercises={reorderExercises}
                onStartWorkout={startWorkout}
              />
            )}

            {view === 'workout' && (
              <WorkoutView
                workout={activeWorkout}
                workoutHistory={workoutHistory}
                onUpdateWorkout={setActiveWorkout}
                onEndWorkout={endWorkout}
                onDiscardWorkout={discardWorkout}
              />
            )}

            {view === 'history' && (
              <HistoryView
                history={workoutHistory}
                programs={programs}
                onDeleteWorkout={deleteWorkout}
                onDeleteExercise={deleteHistoryExercise}
                onEditExercise={(workout, exercise) => openModal('edit-history-exercise', null, null, exercise, workout)}
              />
            )}

            {view === 'account' && (
              <AccountView
                user={user}
                workoutHistory={workoutHistory}
              />
            )}
          </div>

          <nav className="bottom-nav">
            <button
              className={`nav-btn ${view === 'programs' ? 'active' : ''}`}
              onClick={() => setView('programs')}
            >
              <Icon name="clipboard-list" size={22} />
              Programmes
            </button>
            <button
              className={`nav-btn ${view === 'workout' ? 'active' : ''}`}
              onClick={() => setView('workout')}
            >
              <Icon name="dumbbell" size={22} />
              Entraînement
            </button>
            <button
              className={`nav-btn ${view === 'history' ? 'active' : ''}`}
              onClick={() => setView('history')}
            >
              <Icon name="bar-chart" size={22} />
              Historique
            </button>
            <button
              className={`nav-btn ${view === 'account' ? 'active' : ''}`}
              onClick={() => setView('account')}
            >
              <Icon name="user" size={22} />
              Compte
            </button>
          </nav>

          {showModal && (
            <Modal
              type={modalType}
              program={currentProgram}
              session={currentSession}
              exercise={currentExercise}
              workout={currentWorkout}
              onClose={closeModal}
              onAddProgram={addProgram}
              onAddSession={addSession}
              onAddExercise={addExercise}
              onEditExercise={editExercise}
              onEditHistoryExercise={editHistoryExercise}
            />
          )}
        </div>
      );
    }

    const calculateDuration = (start, end) => {
      return Math.round((end - start) / 60000);
    };

    function AccountView({ user, workoutHistory }) {
      const [profile, setProfile] = useState(null);
      const [weekStats, setWeekStats] = useState({ workouts: 0, volume: 0, duration: 0 });
      const [weeklyData, setWeeklyData] = useState([]);
      const [showEditModal, setShowEditModal] = useState(false);
      const [loading, setLoading] = useState(true);

      // Charger le profil et les statistiques
      useEffect(() => {
        const loadAccountData = async () => {
          if (!user) return;
          setLoading(true);

          try {
            const [profileData, stats, weekly] = await Promise.all([
              db.getProfile(user.id),
              db.getWeekStats(user.id),
              db.getWeeklyWorkouts(user.id)
            ]);

            setProfile(profileData);
            setWeekStats(stats);
            setWeeklyData(weekly);
          } catch (error) {
            console.error('Error loading account data:', error);
          } finally {
            setLoading(false);
          }
        };

        loadAccountData();
      }, [user]);

      const handleUpdateProfile = async (updatedProfile) => {
        try {
          await db.updateProfile(user.id, updatedProfile);
          setProfile({
            ...profile,
            first_name: updatedProfile.firstName,
            last_name: updatedProfile.lastName,
            height: updatedProfile.height,
            weight: updatedProfile.weight
          });
          setShowEditModal(false);
        } catch (error) {
          alert('Erreur lors de la mise à jour du profil');
        }
      };

      // Initiales pour l'avatar
      const getInitials = () => {
        if (profile?.first_name && profile?.last_name) {
          return `${profile.first_name.charAt(0)}${profile.last_name.charAt(0)}`.toUpperCase();
        }
        return user?.email?.charAt(0).toUpperCase() || '?';
      };

      // Formater la durée en heures et minutes
      const formatDuration = (minutes) => {
        if (minutes < 60) return `${minutes} min`;
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
      };

      // Formater le volume (kg)
      const formatVolume = (kg) => {
        if (kg >= 1000) {
          return `${(kg / 1000).toFixed(1)}t`;
        }
        return `${kg} kg`;
      };

      // Calculer la hauteur max pour le graphique
      const maxWorkouts = Math.max(...weeklyData.map(w => w.count), 1);

      if (loading) {
        return (
          <div className="account-view">
            <div className="empty-state">
              <div className="empty-icon"><Icon name="loader" size={48} /></div>
              <div className="empty-text">Chargement...</div>
            </div>
          </div>
        );
      }

      return (
        <div className="account-view">
          {/* Bloc Motivation - Statistiques de la semaine */}
          <div className="motivation-block">
            <div className="motivation-title"><Icon name="calendar" size={18} /> Cette semaine</div>
            <div className="week-stats-grid">
              <div className="week-stat-card highlight">
                <div className="week-stat-icon"><Icon name="activity" size={20} /></div>
                <div className="week-stat-value">{weekStats.workouts}</div>
                <div className="week-stat-label">Entraînements</div>
              </div>
              <div className="week-stat-card">
                <div className="week-stat-icon"><Icon name="flame" size={20} /></div>
                <div className="week-stat-value">{formatVolume(weekStats.volume)}</div>
                <div className="week-stat-label">Volume total</div>
              </div>
              <div className="week-stat-card">
                <div className="week-stat-icon"><Icon name="clock" size={20} /></div>
                <div className="week-stat-value">{formatDuration(weekStats.duration)}</div>
                <div className="week-stat-label">Temps total</div>
              </div>
            </div>

            {/* Graphique des 5 dernières semaines */}
            <div className="weekly-chart">
              <div className="chart-title">Séances par semaine</div>
              <div className="chart-container">
                {weeklyData.map((week, idx) => (
                  <div key={idx} className="chart-bar-wrapper">
                    <div className="chart-bar-value">{week.count}</div>
                    <div
                      className={`chart-bar ${idx === weeklyData.length - 1 ? 'current' : ''}`}
                      style={{ height: `${(week.count / maxWorkouts) * 100}%`, minHeight: week.count > 0 ? '8px' : '4px' }}
                    />
                    <div className="chart-bar-label">{week.label}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Bloc Profil */}
          <div className="profile-block">
            <div className="profile-header">
              <div className="profile-avatar">{getInitials()}</div>
              <div className="profile-info">
                <div className="profile-name">
                  {profile?.first_name || 'Utilisateur'}
                </div>
                <div className="profile-fullname">
                  {profile?.first_name && profile?.last_name
                    ? `${profile.first_name} ${profile.last_name}`
                    : user?.email}
                </div>
              </div>
            </div>

            <div className="profile-details">
              <div className="profile-detail">
                <span className="profile-detail-icon"><Icon name="ruler" size={18} /></span>
                <span className="profile-detail-label">Taille</span>
                <span className="profile-detail-value">
                  {profile?.height ? `${profile.height} cm` : '—'}
                </span>
              </div>
              <div className="profile-detail">
                <span className="profile-detail-icon"><Icon name="scale" size={18} /></span>
                <span className="profile-detail-label">Poids</span>
                <span className="profile-detail-value">
                  {profile?.weight ? `${profile.weight} kg` : '—'}
                </span>
              </div>
            </div>

            <button
              className="btn btn-secondary"
              onClick={() => setShowEditModal(true)}
            >
              <Icon name="edit" size={16} /> Modifier le profil
            </button>
          </div>

          {/* Actions */}
          <div className="account-actions">
            <button
              className="btn btn-signout"
              onClick={async () => {
                if (confirm('Se déconnecter ?')) {
                  await auth.signOut();
                }
              }}
            >
              <Icon name="log-out" size={16} /> Se déconnecter
            </button>
          </div>

          {/* Modal d'édition du profil */}
          {showEditModal && (
            <ProfileEditModal
              profile={profile}
              onClose={() => setShowEditModal(false)}
              onSave={handleUpdateProfile}
            />
          )}
        </div>
      );
    }

    function ProfileEditModal({ profile, onClose, onSave }) {
      const [firstName, setFirstName] = useState(profile?.first_name || '');
      const [lastName, setLastName] = useState(profile?.last_name || '');
      const [height, setHeight] = useState(profile?.height?.toString() || '');
      const [weight, setWeight] = useState(profile?.weight?.toString() || '');
      const [saving, setSaving] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);

        try {
          await onSave({
            firstName,
            lastName,
            height: parseInt(height) || null,
            weight: parseFloat(weight) || null
          });
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="modal active" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">Modifier le profil</h2>
              <button className="modal-close" onClick={onClose}><Icon name="x" size={20} /></button>
            </div>

            <form onSubmit={handleSubmit}>
              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Prénom</label>
                  <input
                    type="text"
                    className="form-input"
                    value={firstName}
                    onChange={(e) => setFirstName(e.target.value)}
                    placeholder="Jean"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Nom</label>
                  <input
                    type="text"
                    className="form-input"
                    value={lastName}
                    onChange={(e) => setLastName(e.target.value)}
                    placeholder="Dupont"
                  />
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Taille (cm)</label>
                  <input
                    type="number"
                    className="form-input"
                    value={height}
                    onChange={(e) => setHeight(e.target.value)}
                    placeholder="175"
                    min="100"
                    max="250"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Poids (kg)</label>
                  <input
                    type="number"
                    step="0.1"
                    className="form-input"
                    value={weight}
                    onChange={(e) => setWeight(e.target.value)}
                    placeholder="70.5"
                    min="30"
                    max="300"
                  />
                </div>
              </div>

              <div className="modal-actions">
                <button type="button" className="btn btn-secondary" onClick={onClose}>
                  Annuler
                </button>
                <button type="submit" className="btn" disabled={saving}>
                  {saving ? 'Enregistrement...' : 'Enregistrer'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function AuthScreen() {
      const [mode, setMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [height, setHeight] = useState('');
      const [weight, setWeight] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (mode === 'login') {
            await auth.signIn(email, password);
          } else {
            // Inscription
            const { user } = await auth.signUp(email, password);

            // Créer le profil avec les informations personnelles
            if (user) {
              await db.updateProfile(user.id, {
                firstName,
                lastName,
                height: parseInt(height) || null,
                weight: parseFloat(weight) || null
              });
            }

            alert('Compte créé ! Vous pouvez maintenant vous connecter.');
            setMode('login');
            // Reset form
            setFirstName('');
            setLastName('');
            setHeight('');
            setWeight('');
          }
        } catch (err) {
          setError(err.message || 'Une erreur est survenue');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="auth-container">
          <h1 className="auth-title">GymTracker</h1>
          <div className="auth-subtitle">Ton coach personnel <Icon name="dumbbell" size={16} /></div>

          <div className="auth-tabs">
            <button
              className={`auth-tab ${mode === 'login' ? 'active' : ''}`}
              onClick={() => setMode('login')}
            >
              Connexion
            </button>
            <button
              className={`auth-tab ${mode === 'signup' ? 'active' : ''}`}
              onClick={() => setMode('signup')}
            >
              Inscription
            </button>
          </div>

          {error && (
            <div className="auth-error">{error}</div>
          )}

          <form onSubmit={handleSubmit}>
            {mode === 'signup' && (
              <>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Prénom</label>
                    <input
                      type="text"
                      className="form-input"
                      value={firstName}
                      onChange={(e) => setFirstName(e.target.value)}
                      placeholder="Jean"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Nom</label>
                    <input
                      type="text"
                      className="form-input"
                      value={lastName}
                      onChange={(e) => setLastName(e.target.value)}
                      placeholder="Dupont"
                      required
                    />
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Taille (cm)</label>
                    <input
                      type="number"
                      className="form-input"
                      value={height}
                      onChange={(e) => setHeight(e.target.value)}
                      placeholder="175"
                      min="100"
                      max="250"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Poids (kg)</label>
                    <input
                      type="number"
                      step="0.1"
                      className="form-input"
                      value={weight}
                      onChange={(e) => setWeight(e.target.value)}
                      placeholder="70.5"
                      min="30"
                      max="300"
                      required
                    />
                  </div>
                </div>
              </>
            )}

            <div className="form-group">
              <label className="form-label">Email</label>
              <input
                type="email"
                className="form-input"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                autoFocus={mode === 'login'}
              />
            </div>

            <div className="form-group">
              <label className="form-label">Mot de passe</label>
              <input
                type="password"
                className="form-input"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                minLength="6"
              />
            </div>

            <button type="submit" className="btn" disabled={loading}>
              {loading ? 'Chargement...' : mode === 'login' ? 'Se connecter' : 'Créer un compte'}
            </button>
          </form>

          {mode === 'login' && (
            <div className="auth-footer">
              Pas encore de compte ?{' '}
              <span className="auth-link" onClick={() => setMode('signup')}>
                Inscris-toi
              </span>
            </div>
          )}
        </div>
      );
    }
    function ProgramsView({ programs, onAddProgram, onDeleteProgram, onAddSession, onDeleteSession, onAddExercise, onEditExercise, onDeleteExercise, onReorderExercises, onStartWorkout }) {
      const [expandedProgram, setExpandedProgram] = useState(null);
      const [expandedSession, setExpandedSession] = useState(null);
      const dragState = useRef({
        isDragging: false,
        exercise: null,
        sessionId: null,
        startY: 0,
        currentY: 0,
        ghost: null,
        sourceEl: null,
        targetEl: null,
        insertPosition: null
      });

      const clearDragClasses = () => {
        document.querySelectorAll('.dragging, .drag-over-top, .drag-over-bottom').forEach(el => {
          el.classList.remove('dragging', 'drag-over-top', 'drag-over-bottom');
        });
      };

      const removeGhost = () => {
        if (dragState.current.ghost) {
          dragState.current.ghost.remove();
          dragState.current.ghost = null;
        }
      };

      const createGhost = (sourceEl, x, y) => {
        const ghost = sourceEl.cloneNode(true);
        const rect = sourceEl.getBoundingClientRect();
        ghost.className = 'drag-ghost';
        ghost.style.width = rect.width + 'px';
        ghost.style.left = rect.left + 'px';
        ghost.style.top = y - 30 + 'px';
        document.body.appendChild(ghost);
        return ghost;
      };

      const handleTouchStart = (e, exercise, sessionId) => {
        const wrapper = e.target.closest('.exercise-item-wrapper');
        if (!wrapper) return;

        const touch = e.touches[0];
        const startX = touch.clientX;
        const startY = touch.clientY;

        // Initialiser l'état en attente
        dragState.current = {
          isDragging: false,
          isPending: true,
          exercise,
          sessionId,
          startX,
          startY,
          currentY: startY,
          ghost: null,
          sourceEl: wrapper,
          targetEl: null,
          insertPosition: null,
          startTimer: null
        };

        // Délai avant de commencer le drag (150ms)
        dragState.current.startTimer = setTimeout(() => {
          if (dragState.current.isPending && dragState.current.sourceEl === wrapper) {
            dragState.current.isDragging = true;
            dragState.current.isPending = false;
            dragState.current.ghost = createGhost(wrapper, startX, dragState.current.currentY);
            wrapper.classList.add('dragging');
          }
        }, 150);
      };

      const handleTouchMove = (e, session) => {
        const touch = e.touches[0];

        // Si en mode scroll, simuler le scroll avec requestAnimationFrame
        if (dragState.current.isScrolling) {
          const currentY = touch.clientY;
          if (!dragState.current.scrollRAF) {
            dragState.current.scrollRAF = requestAnimationFrame(() => {
              const deltaY = currentY - dragState.current.lastY;
              dragState.current.lastY = currentY;
              window.scrollBy({ top: -deltaY, behavior: 'instant' });
              dragState.current.scrollRAF = null;
            });
          }
          return;
        }

        // Si en attente (pendant le délai), vérifier si c'est un scroll
        if (dragState.current.isPending && !dragState.current.isDragging) {
          const deltaY = Math.abs(touch.clientY - dragState.current.startY);
          const deltaX = Math.abs(touch.clientX - dragState.current.startX);

          // Si mouvement > 10px, c'est un scroll
          if (deltaY > 10 || deltaX > 10) {
            if (dragState.current.startTimer) {
              clearTimeout(dragState.current.startTimer);
              dragState.current.startTimer = null;
            }
            dragState.current.isPending = false;
            dragState.current.isScrolling = true;
            dragState.current.lastY = touch.clientY;
            return;
          }
          return;
        }

        if (!dragState.current.isDragging) return;
        e.preventDefault();

        dragState.current.currentY = touch.clientY;

        // Déplacer le ghost
        if (dragState.current.ghost) {
          dragState.current.ghost.style.top = touch.clientY - 30 + 'px';
        }

        // Trouver l'élément sous le doigt
        const elementsUnder = document.elementsFromPoint(touch.clientX, touch.clientY);
        const targetWrapper = elementsUnder.find(el =>
          el.classList.contains('exercise-item-wrapper') &&
          el !== dragState.current.sourceEl
        );

        // Nettoyer les anciennes classes
        document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
          if (el !== targetWrapper) {
            el.classList.remove('drag-over-top', 'drag-over-bottom');
          }
        });

        if (targetWrapper) {
          const rect = targetWrapper.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;

          dragState.current.targetEl = targetWrapper;

          if (touch.clientY < midY) {
            targetWrapper.classList.remove('drag-over-bottom');
            targetWrapper.classList.add('drag-over-top');
            dragState.current.insertPosition = 'before';
          } else {
            targetWrapper.classList.remove('drag-over-top');
            targetWrapper.classList.add('drag-over-bottom');
            dragState.current.insertPosition = 'after';
          }
        } else {
          dragState.current.targetEl = null;
          dragState.current.insertPosition = null;
        }
      };

      const handleTouchEnd = (e, session) => {
        // Annuler le timer si le drag n'a pas commencé
        if (dragState.current.startTimer) {
          clearTimeout(dragState.current.startTimer);
          dragState.current.startTimer = null;
        }

        if (!dragState.current.isDragging) {
          dragState.current = { isDragging: false, isPending: false, isScrolling: false };
          return;
        }

        const { exercise, targetEl, insertPosition } = dragState.current;

        if (targetEl && insertPosition) {
          const targetId = targetEl.dataset.exerciseId;
          const exercises = [...session.exercises];
          const draggedIndex = exercises.findIndex(ex => ex.id === exercise.id);
          let targetIndex = exercises.findIndex(ex => ex.id === targetId);

          if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
            const [removed] = exercises.splice(draggedIndex, 1);

            // Ajuster l'index si on a retiré un élément avant
            if (draggedIndex < targetIndex) {
              targetIndex--;
            }

            if (insertPosition === 'after') {
              targetIndex++;
            }

            exercises.splice(targetIndex, 0, removed);
            onReorderExercises(session.id, exercises.map(ex => ex.id));
          }
        }

        clearDragClasses();
        removeGhost();
        dragState.current.isDragging = false;
      };

      if (programs.length === 0) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon"><Icon name="dumbbell" size={48} /></div>
              <div className="empty-text">Crée ton premier programme !</div>
            </div>
            <button className="btn" onClick={onAddProgram}>
              + Créer un programme
            </button>
          </div>
        );
      }

      return (
        <div className="view active">
          {programs.map(program => (
            <div key={program.id} className="card">
              <div onClick={() => setExpandedProgram(expandedProgram === program.id ? null : program.id)}>
                <div className="card-title">{program.name}</div>
                <div className="card-meta">
                  {program.sessions.length} séance{program.sessions.length > 1 ? 's' : ''}
                </div>
              </div>

              {expandedProgram === program.id && (
                <div style={{ marginTop: '16px' }}>
                  {program.sessions.map(session => (
                    <div key={session.id} style={{ marginBottom: '12px' }}>
                      <div
                        className="exercise-item"
                        onClick={() => setExpandedSession(expandedSession === session.id ? null : session.id)}
                      >
                        <div className="exercise-name">{session.name}</div>
                        <div className="exercise-rest">
                          {session.exercises.length} exercice{session.exercises.length > 1 ? 's' : ''}
                        </div>
                      </div>

                      {expandedSession === session.id && (
                        <div style={{ marginTop: '8px', paddingLeft: '8px' }}>
                          {session.exercises.map((exercise, index) => (
                            <div
                              key={exercise.id}
                              className="exercise-item-wrapper"
                              data-exercise-id={exercise.id}
                              onTouchStart={(e) => handleTouchStart(e, exercise, session.id)}
                              onTouchMove={(e) => handleTouchMove(e, session)}
                              onTouchEnd={(e) => handleTouchEnd(e, session)}
                            >
                              <div className="exercise-order-number">{index + 1}</div>
                              <div className="exercise-content">
                                <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>{exercise.name}</div>
                                <div style={{ color: 'var(--text-secondary)', fontSize: '12px', marginBottom: '8px' }}>
                                  {exercise.sets} séries • Repos: {exercise.restTime}s
                                </div>
                                {exercise.notes && (
                                  <div style={{
                                    fontSize: '12px',
                                    fontStyle: 'italic',
                                    color: 'var(--text-secondary)',
                                    marginBottom: '8px',
                                    paddingLeft: '8px',
                                    borderLeft: '2px solid var(--border)'
                                  }}>
                                    {exercise.notes}
                                  </div>
                                )}
                                <div className="exercise-actions">
                                  <button
                                    className="btn-small btn-secondary"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onEditExercise(program, session, exercise);
                                    }}
                                  >
                                    Modifier
                                  </button>
                                  <button
                                    className="btn-small btn-delete"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onDeleteExercise(program.id, session.id, exercise.id);
                                    }}
                                  >
                                    Supprimer
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                          <div className="session-buttons">
                            <button
                              className="btn btn-secondary"
                              onClick={() => onAddExercise(program, session)}
                            >
                              + Ajouter un exercice
                            </button>
                            <button
                              className="btn"
                              onClick={() => onStartWorkout(program, session)}
                            >
                              <Icon name="play" size={16} /> Démarrer cette séance
                            </button>
                            <button
                              className="btn btn-delete"
                              onClick={() => onDeleteSession(program.id, session.id)}
                            >
                              Supprimer la séance
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}

                  <div className="card-actions">
                    <button
                      className="btn btn-secondary"
                      onClick={() => onAddSession(program)}
                    >
                      + Nouvelle séance
                    </button>
                    <button
                      className="btn btn-delete"
                      onClick={() => onDeleteProgram(program.id)}
                    >
                      Supprimer
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}

          <button className="btn" style={{ marginTop: '20px' }} onClick={onAddProgram}>
            + Nouveau Programme
          </button>
        </div>
      );
    }

    function WorkoutView({ workout, workoutHistory, onUpdateWorkout, onEndWorkout, onDiscardWorkout }) {
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const [restTimer, setRestTimer] = useState(null);
      const [restRemaining, setRestRemaining] = useState(0);
      const [showSuccess, setShowSuccess] = useState(false);
      const [showEndModal, setShowEndModal] = useState(false);
      const timerRef = useRef(null);

      useEffect(() => {
        if (restTimer !== null) {
          const startTime = Date.now();
          const endTime = startTime + restTimer * 1000;

          timerRef.current = setInterval(() => {
            const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
            setRestRemaining(remaining);

            if (remaining === 0) {
              clearInterval(timerRef.current);
              setRestTimer(null);
              if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
              }
            }
          }, 100);

          return () => clearInterval(timerRef.current);
        }
      }, [restTimer]);

      if (!workout) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon"><Icon name="dumbbell" size={48} /></div>
              <div className="empty-text">Sélectionne une séance pour commencer</div>
            </div>
          </div>
        );
      }

      const currentExercise = workout.exercises[currentExerciseIndex];

      // Find last performance and PR for this exercise
      const getExercisePerformances = (exerciseName) => {
        const performances = [];
        let maxWeight = 0;
        let maxReps = 0;
        const prs = [];

        for (let i = 0; i < workoutHistory.length; i++) {
          const historyWorkout = workoutHistory[i];
          const exerciseData = historyWorkout.exercises.find(e => e.name === exerciseName);
          if (exerciseData) {
            const completedSets = exerciseData.sets.filter(s => s.completed);
            if (completedSets.length > 0) {
              if (performances.length === 0) {
                // This is the last performance
                performances.push({ type: 'last', sets: completedSets });
              }

              // Check for PRs
              completedSets.forEach((set, idx) => {
                const weight = parseFloat(set.weight) || 0;
                const reps = parseInt(set.reps) || 0;

                if (!prs[idx] || weight > (parseFloat(prs[idx].weight) || 0) ||
                  (weight === parseFloat(prs[idx].weight) && reps > (parseInt(prs[idx].reps) || 0))) {
                  prs[idx] = set;
                  if (weight > maxWeight || (weight === maxWeight && reps > maxReps)) {
                    maxWeight = weight;
                    maxReps = reps;
                  }
                }
              });
            }
          }
        }

        return { last: performances[0]?.sets || null, prs };
      };

      const { last: lastPerformance, prs: prSets } = getExercisePerformances(currentExercise.name);

      // Auto-fill from last performance on mount
      useEffect(() => {
        if (lastPerformance && currentExercise.sets.every(s => !s.reps && !s.weight)) {
          const updated = { ...workout };
          lastPerformance.forEach((lastSet, idx) => {
            if (updated.exercises[currentExerciseIndex].sets[idx]) {
              updated.exercises[currentExerciseIndex].sets[idx].reps = lastSet.reps;
              updated.exercises[currentExerciseIndex].sets[idx].weight = lastSet.weight;
            }
          });
          onUpdateWorkout(updated);
        }
      }, [currentExerciseIndex]);

      const updateSet = (setIndex, field, value) => {
        const updated = { ...workout };
        updated.exercises[currentExerciseIndex].sets[setIndex][field] = value;
        onUpdateWorkout(updated);
      };

      const adjustWeight = (setIndex, delta) => {
        const updated = { ...workout };
        const currentValue = parseFloat(updated.exercises[currentExerciseIndex].sets[setIndex].weight) || 0;
        const newValue = Math.max(0, currentValue + delta);
        updated.exercises[currentExerciseIndex].sets[setIndex].weight = newValue.toString();
        onUpdateWorkout(updated);
      };

      const completeSet = (setIndex) => {
        const updated = { ...workout };
        const set = updated.exercises[currentExerciseIndex].sets[setIndex];
        set.completed = !set.completed;

        if (set.completed && currentExercise.restTime) {
          setRestTimer(currentExercise.restTime);

          // Check if PR
          const prSet = prSets[setIndex];
          if (prSet) {
            const isPR = parseFloat(set.weight) > parseFloat(prSet.weight) ||
              (parseFloat(set.weight) === parseFloat(prSet.weight) &&
                parseInt(set.reps) > parseInt(prSet.reps));

            if (isPR) {
              setShowSuccess(true);
              setTimeout(() => setShowSuccess(false), 3000);
            }
          } else if (set.reps && set.weight) {
            // First time doing this exercise
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
          }
        }

        onUpdateWorkout(updated);
      };

      const skipRestTimer = () => {
        clearInterval(timerRef.current);
        setRestTimer(null);
        setRestRemaining(0);
      };

      const getComparison = (setIndex) => {
        if (!lastPerformance || !lastPerformance[setIndex]) return null;

        const currentSet = currentExercise.sets[setIndex];
        const lastSet = lastPerformance[setIndex];

        if (!currentSet.completed || !currentSet.reps || !currentSet.weight) return null;

        const weightDiff = parseFloat(currentSet.weight) - parseFloat(lastSet.weight);
        const repsDiff = parseInt(currentSet.reps) - parseInt(lastSet.reps);

        if (weightDiff > 0) {
          return { text: `+${weightDiff}kg`, positive: true };
        } else if (weightDiff === 0 && repsDiff > 0) {
          return { text: `+${repsDiff} reps`, positive: true };
        } else if (weightDiff < 0) {
          return { text: `${weightDiff}kg`, positive: false };
        } else if (repsDiff < 0) {
          return { text: `${repsDiff} reps`, positive: false };
        }
        return null;
      };

      return (
        <div className="view active">
          <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontWeight: '600' }}>
                {workout.program.name} → {workout.session.name}
              </div>
              <div style={{ fontSize: '22px', fontWeight: '700', marginTop: '4px', fontFamily: 'Poppins' }}>
                Exercice {currentExerciseIndex + 1}/{workout.exercises.length}
              </div>
            </div>
            <button className="btn-small btn-delete" onClick={() => setShowEndModal(true)}>
              Terminer
            </button>
          </div>

          {/* Modal de fin d'entraînement */}
          {showEndModal && (
            <div className="modal active" onClick={() => setShowEndModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 className="modal-title">Terminer l'entraînement ?</h2>
                  <button className="modal-close" onClick={() => setShowEndModal(false)}><Icon name="x" size={20} /></button>
                </div>
                <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>
                  Que souhaitez-vous faire avec cet entraînement ?
                </p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <button
                    className="btn"
                    onClick={() => {
                      setShowEndModal(false);
                      onEndWorkout(workout);
                    }}
                  >
                    ✓ Enregistrer dans l'historique
                  </button>
                  <button
                    className="btn btn-delete"
                    onClick={() => {
                      setShowEndModal(false);
                      onDiscardWorkout();
                    }}
                  >
                    <Icon name="trash" size={16} /> Supprimer sans enregistrer
                  </button>
                  <button
                    className="btn btn-secondary"
                    onClick={() => setShowEndModal(false)}
                  >
                    Continuer l'entraînement
                  </button>
                </div>
              </div>
            </div>
          )}

          {showSuccess && (
            <div className="success-message">
              <Icon name="trophy" size={20} /> Nouveau record personnel !
            </div>
          )}

          {restTimer !== null && (
            <div className="rest-timer">
              <div className="rest-timer-bg" style={{ width: `${(restRemaining / restTimer) * 100}%` }}></div>
              <div className="rest-timer-content">
                <div className="rest-timer-label">Temps de repos</div>
                <div className="rest-timer-time">{restRemaining}s</div>
                <button className="btn-small btn-secondary" style={{ marginTop: '12px' }} onClick={skipRestTimer}>
                  Passer
                </button>
              </div>
            </div>
          )}

          <div className="tracker-exercise current">
            <div className="tracker-header">
              <div className="tracker-title">{currentExercise.name}</div>
            </div>

            {currentExercise.notes && (
              <div style={{
                background: 'var(--bg-tertiary)',
                padding: '12px',
                borderRadius: '12px',
                marginBottom: '16px',
                fontSize: '13px',
                fontStyle: 'italic',
                color: 'var(--text-secondary)'
              }}>
                <Icon name="file-text" size={14} /> {currentExercise.notes}
              </div>
            )}

            {(lastPerformance || prSets.length > 0) && (
              <div className="past-performance">
                <div className="past-performance-title">Performances Passées</div>
                {currentExercise.sets.map((_, idx) => {
                  const lastSet = lastPerformance?.[idx];
                  const prSet = prSets[idx];
                  const isPR = lastSet && prSet &&
                    parseFloat(lastSet.weight) === parseFloat(prSet.weight) &&
                    parseInt(lastSet.reps) === parseInt(prSet.reps);

                  if (!lastSet && !prSet) return null;

                  return (
                    <div key={idx} className="past-performance-row">
                      <span>
                        S{idx + 1}: {lastSet ? `${lastSet.reps} × ${lastSet.weight}kg` : '-'}
                      </span>
                      {isPR ? (
                        <span className="pr-badge"><Icon name="trophy" size={12} /> PR</span>
                      ) : prSet && lastSet && (parseFloat(prSet.weight) !== parseFloat(lastSet.weight) || parseInt(prSet.reps) !== parseInt(lastSet.reps)) ? (
                        <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                          Record: {prSet.reps} × {prSet.weight}kg
                        </span>
                      ) : null}
                    </div>
                  );
                })}
              </div>
            )}

            {currentExercise.sets.map((set, idx) => {
              const comparison = getComparison(idx);
              return (
                <div key={idx}>
                  <div className="set-row">
                    <div className="set-label">S{idx + 1}</div>
                    <div className="set-inputs">
                      <div className="input-with-label">
                        <div className="input-label">Reps</div>
                        <input
                          type="number"
                          inputMode="numeric"
                          className="set-input"
                          placeholder="0"
                          value={set.reps}
                          onChange={(e) => updateSet(idx, 'reps', e.target.value)}
                          disabled={set.completed}
                        />
                      </div>
                      <div className="input-with-label">
                        <div className="input-label">Poids (kg)</div>
                        <div className="input-with-steppers">
                          <button
                            className="stepper-btn double"
                            onClick={() => adjustWeight(idx, -5)}
                            disabled={set.completed}
                          >
                            --
                          </button>
                          <button
                            className="stepper-btn"
                            onClick={() => adjustWeight(idx, -2.5)}
                            disabled={set.completed}
                          >
                            -
                          </button>
                          <input
                            type="number"
                            inputMode="decimal"
                            className="set-input"
                            placeholder="0"
                            value={set.weight}
                            onChange={(e) => updateSet(idx, 'weight', e.target.value)}
                            disabled={set.completed}
                          />
                          <button
                            className="stepper-btn"
                            onClick={() => adjustWeight(idx, 2.5)}
                            disabled={set.completed}
                          >
                            +
                          </button>
                          <button
                            className="stepper-btn double"
                            onClick={() => adjustWeight(idx, 5)}
                            disabled={set.completed}
                          >
                            ++
                          </button>
                        </div>
                      </div>
                    </div>
                    <button
                      className={`set-done ${set.completed ? 'completed' : ''}`}
                      onClick={() => completeSet(idx)}
                    >
                      {set.completed ? '✓' : 'Fait'}
                    </button>
                  </div>
                  {comparison && (
                    <div style={{ marginBottom: '12px', fontSize: '12px', textAlign: 'center' }}>
                      <span className={`comparison-badge ${comparison.positive ? '' : 'negative'}`}>
                        {comparison.text}
                      </span>
                    </div>
                  )}
                </div>
              );
            })}

            <div className="workout-nav">
              {currentExerciseIndex > 0 && (
                <button
                  className="btn btn-secondary"
                  onClick={() => setCurrentExerciseIndex(currentExerciseIndex - 1)}
                >
                  ← Préc.
                </button>
              )}
              {currentExerciseIndex < workout.exercises.length - 1 && (
                <button
                  className="btn"
                  onClick={() => setCurrentExerciseIndex(currentExerciseIndex + 1)}
                >
                  Suivant →
                </button>
              )}
            </div>
          </div>

          <div style={{ marginTop: '24px' }}>
            <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '12px', fontWeight: '600' }}>
              Exercices suivants
            </div>
            {workout.exercises.map((ex, idx) => (
              idx !== currentExerciseIndex && (
                <div
                  key={idx}
                  className="exercise-item"
                  onClick={() => setCurrentExerciseIndex(idx)}
                  style={{ cursor: 'pointer', opacity: idx < currentExerciseIndex ? 0.6 : 1 }}
                >
                  <div className="exercise-name">
                    {idx < currentExerciseIndex ? '✓ ' : ''}{ex.name}
                  </div>
                  <div className="exercise-rest">
                    {ex.sets.filter(s => s.completed).length}/{ex.sets.length} séries
                  </div>
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    function HistoryView({ history, programs, onDeleteWorkout, onDeleteExercise, onEditExercise }) {
      const [filter, setFilter] = useState('all');
      const [expandedWorkout, setExpandedWorkout] = useState(null);
      const [viewMode, setViewMode] = useState('sessions');
      const [selectedExercise, setSelectedExercise] = useState(null);

      const getAllExercises = () => {
        const exercises = new Set();
        history.forEach(workout => {
          workout.exercises.forEach(ex => {
            exercises.add(ex.name);
          });
        });
        return Array.from(exercises);
      };

      const allExercises = getAllExercises();

      const filteredHistory = filter === 'all'
        ? history
        : history.filter(w => w.programId === filter);

      const getExerciseHistory = (exerciseName) => {
        return history
          .map(workout => ({
            ...workout,
            exerciseData: workout.exercises.find(e => e.name === exerciseName)
          }))
          .filter(w => w.exerciseData)
          .map(w => ({
            date: w.completedAt,
            sets: w.exerciseData.sets.filter(s => s.completed)
          }));
      };

      const getPersonalRecord = (exerciseName) => {
        const exerciseHistory = getExerciseHistory(exerciseName);
        let maxWeight = 0;
        let maxReps = 0;

        exerciseHistory.forEach(({ sets }) => {
          sets.forEach(set => {
            const weight = parseFloat(set.weight) || 0;
            const reps = parseInt(set.reps) || 0;
            if (weight > maxWeight || (weight === maxWeight && reps > maxReps)) {
              maxWeight = weight;
              maxReps = reps;
            }
          });
        });

        return maxWeight > 0 ? `${maxWeight}kg × ${maxReps}` : null;
      };

      if (history.length === 0) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon"><Icon name="bar-chart" size={48} /></div>
              <div className="empty-text">Aucun entraînement enregistré</div>
            </div>
          </div>
        );
      }

      return (
        <div className="view active">
          <div className="history-filters">
            <button
              className={`filter-btn ${viewMode === 'sessions' ? 'active' : ''}`}
              onClick={() => setViewMode('sessions')}
            >
              <Icon name="calendar" size={16} /> Séances
            </button>
            <button
              className={`filter-btn ${viewMode === 'exercises' ? 'active' : ''}`}
              onClick={() => setViewMode('exercises')}
            >
              <Icon name="dumbbell" size={16} /> Exercices
            </button>
          </div>

          {viewMode === 'sessions' && (
            <>
              <div className="history-filters">
                <button
                  className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                  onClick={() => setFilter('all')}
                >
                  Tout
                </button>
                {programs.map(program => (
                  <button
                    key={program.id}
                    className={`filter-btn ${filter === program.id ? 'active' : ''}`}
                    onClick={() => setFilter(program.id)}
                  >
                    {program.name}
                  </button>
                ))}
              </div>

              {filteredHistory.map(workout => (
                <div key={workout.id} className="history-card">
                  <div className="history-card-header">
                    <div
                      className="history-card-content"
                      onClick={() => setExpandedWorkout(expandedWorkout === workout.id ? null : workout.id)}
                    >
                      <div className="history-date">{formatDate(workout.completedAt)}</div>
                      <div className="history-title">{workout.sessionName}</div>
                      <div className="history-stats">
                        <div className="stat-badge"><Icon name="clock" size={14} /> {workout.duration} min</div>
                        <div className="stat-badge"><Icon name="dumbbell" size={14} /> {workout.exercises.length} exercices</div>
                      </div>
                    </div>
                    <div className="history-card-actions">
                      <button
                        className="icon-btn delete"
                        onClick={(e) => {
                          e.stopPropagation();
                          onDeleteWorkout(workout.id);
                        }}
                        title="Supprimer la séance"
                      >
                        <Icon name="trash" size={16} />
                      </button>
                    </div>
                  </div>

                  {expandedWorkout === workout.id && (
                    <div style={{ marginTop: '12px' }}>
                      {workout.exercises.map((exercise, idx) => {
                        const completedSets = exercise.sets.filter(s => s.completed);
                        return (
                          <div key={idx} className="exercise-detail">
                            <div className="exercise-detail-header">
                              <div className="exercise-detail-title">{exercise.name}</div>
                              <div style={{ display: 'flex', gap: '6px' }}>
                                <button
                                  className="icon-btn"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onEditExercise(workout, exercise);
                                  }}
                                  title="Modifier"
                                >
                                  <Icon name="edit" size={16} />
                                </button>
                                <button
                                  className="icon-btn delete"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onDeleteExercise(workout.id, exercise.id);
                                  }}
                                  title="Supprimer"
                                >
                                  <Icon name="trash" size={16} />
                                </button>
                              </div>
                            </div>
                            <div className="exercise-detail-sets">
                              {completedSets.map((set, sidx) => (
                                <div key={sidx}>
                                  S{sidx + 1}: {set.reps} reps × {set.weight}kg
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              ))}
            </>
          )}

          {viewMode === 'exercises' && (
            <>
              {allExercises.map(exerciseName => {
                const exerciseHistory = getExerciseHistory(exerciseName);
                const pr = getPersonalRecord(exerciseName);
                const isExpanded = selectedExercise === exerciseName;

                return (
                  <div key={exerciseName} className="progression-card">
                    <div onClick={() => setSelectedExercise(isExpanded ? null : exerciseName)}>
                      <div className="progression-header">
                        <div className="progression-title">{exerciseName}</div>
                        {pr && <div className="progression-pr">PR: {pr}</div>}
                      </div>
                      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontWeight: '600' }}>
                        {exerciseHistory.length} séance{exerciseHistory.length > 1 ? 's' : ''}
                      </div>
                    </div>

                    {isExpanded && (
                      <div className="progression-list" style={{ marginTop: '12px' }}>
                        {exerciseHistory.slice(0, 5).map((session, idx) => (
                          <div key={idx} style={{ marginBottom: '8px', paddingBottom: '8px', borderBottom: '1px solid var(--border)' }}>
                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '4px' }}>
                              {formatDate(session.date)}
                            </div>
                            {session.sets.map((set, sidx) => (
                              <div key={sidx}>
                                S{sidx + 1}: {set.reps} reps × {set.weight}kg
                              </div>
                            ))}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </>
          )}
        </div>
      );
    }

    function Modal({ type, program, session, exercise, workout, onClose, onAddProgram, onAddSession, onAddExercise, onEditExercise, onEditHistoryExercise }) {
      const [formData, setFormData] = useState({
        name: exercise?.name || '',
        sets: exercise?.sets?.toString() || '3',
        restTime: exercise?.restTime?.toString() || '90',
        notes: exercise?.notes || ''
      });

      const [historySets, setHistorySets] = useState(
        Array.isArray(exercise?.sets)
          ? exercise.sets.filter(s => s.completed).map((s, idx) => ({
            index: idx,
            reps: s.reps,
            weight: s.weight
          }))
          : []
      );

      const handleSubmit = (e) => {
        e.preventDefault();

        if (type === 'program') {
          onAddProgram(formData.name);
        } else if (type === 'session') {
          onAddSession(program.id, formData.name);
        } else if (type === 'exercise') {
          onAddExercise(program.id, session.id, {
            name: formData.name,
            sets: parseInt(formData.sets),
            restTime: parseInt(formData.restTime),
            notes: formData.notes
          });
        } else if (type === 'edit-exercise') {
          onEditExercise(program.id, session.id, exercise.id, {
            name: formData.name,
            sets: parseInt(formData.sets),
            restTime: parseInt(formData.restTime),
            notes: formData.notes
          });
        } else if (type === 'edit-history-exercise') {
          const updatedSets = exercise.sets.map((set, idx) => {
            const historySet = historySets.find(s => s.index === idx);
            if (set.completed && historySet) {
              return { ...set, reps: historySet.reps, weight: historySet.weight };
            }
            return set;
          });
          onEditHistoryExercise(workout.id, exercise.id, updatedSets);
        }
      };

      const updateHistorySet = (index, field, value) => {
        setHistorySets(historySets.map(s =>
          s.index === index ? { ...s, [field]: value } : s
        ));
      };

      return (
        <div className="modal active" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">
                {type === 'program' && 'Nouveau Programme'}
                {type === 'session' && 'Nouvelle Séance'}
                {type === 'exercise' && 'Nouvel Exercice'}
                {type === 'edit-exercise' && 'Modifier Exercice'}
                {type === 'edit-history-exercise' && 'Modifier Performance'}
              </h2>
              <button className="modal-close" onClick={onClose}><Icon name="x" size={20} /></button>
            </div>

            <form onSubmit={handleSubmit}>
              {type === 'edit-history-exercise' ? (
                <>
                  <div style={{ marginBottom: '16px', fontSize: '15px', fontWeight: '600' }}>
                    {exercise.name}
                  </div>
                  {historySets.map((set) => (
                    <div key={set.index} style={{ marginBottom: '12px' }}>
                      <div style={{ fontSize: '13px', fontWeight: '600', marginBottom: '6px' }}>
                        Série {set.index + 1}
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <div style={{ flex: 1 }}>
                          <label className="form-label">Reps</label>
                          <input
                            type="number"
                            className="form-input"
                            value={set.reps}
                            onChange={(e) => updateHistorySet(set.index, 'reps', e.target.value)}
                            required
                          />
                        </div>
                        <div style={{ flex: 1 }}>
                          <label className="form-label">Poids (kg)</label>
                          <input
                            type="number"
                            className="form-input"
                            value={set.weight}
                            onChange={(e) => updateHistorySet(set.index, 'weight', e.target.value)}
                            required
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </>
              ) : (
                <>
                  <div className="form-group">
                    <label className="form-label">Nom</label>
                    <input
                      type="text"
                      className="form-input"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      placeholder={
                        type === 'program' ? 'Ex: PPL Split' :
                          type === 'session' ? 'Ex: Push' :
                            'Ex: Développé Couché'
                      }
                      required
                      autoFocus
                    />
                  </div>

                  {(type === 'exercise' || type === 'edit-exercise') && (
                    <>
                      <div className="form-group">
                        <label className="form-label">Nombre de séries</label>
                        <input
                          type="number"
                          className="form-input"
                          value={formData.sets}
                          onChange={(e) => setFormData({ ...formData, sets: e.target.value })}
                          min="1"
                          max="20"
                          required
                        />
                      </div>

                      <div className="form-group">
                        <label className="form-label">Temps de repos (secondes)</label>
                        <input
                          type="number"
                          className="form-input"
                          value={formData.restTime}
                          onChange={(e) => setFormData({ ...formData, restTime: e.target.value })}
                          min="0"
                          max="600"
                          required
                        />
                      </div>

                      <div className="form-group">
                        <label className="form-label">Notes (optionnel)</label>
                        <textarea
                          className="form-input"
                          value={formData.notes}
                          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                          placeholder="Ex: Utiliser la prise large"
                          rows="3"
                        />
                      </div>
                    </>
                  )}
                </>
              )}

              <button type="submit" className="btn">
                {type === 'edit-exercise' || type === 'edit-history-exercise' ? 'Sauvegarder' : 'Créer'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKCkgPT4gc2VsZi5za2lwV2FpdGluZygpKTs=')
          .catch(() => { });
      });
    }
  </script>
</body>

</html>