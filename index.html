<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GymTracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3ltVHJhY2tlciIsInNob3J0X25hbWUiOiJHeW1UcmFja2VyIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkY1RjAiLCJ0aGVtZV9jb2xvciI6IiNGRjZCNkIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyM0ZGNkI2QicvJTNFJTNDdGV4dCB4PScyNSUyNScgeT0nNjUlMjUnIGZvbnQtc2l6ZT0nNjAnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nQXJpYWwlMkNzYW5zLXNlcmlmJyUzRUclM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=DM+Sans:wght@400;500;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --bg-primary: #FFF5F0;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #FFE8E0;
      --text-primary: #2D2D2D;
      --text-secondary: #8B8B8B;
      --accent: #FF6B6B;
      --accent-hover: #FF8E8E;
      --accent-light: #FFB5B5;
      --success: #4ECDC4;
      --success-light: #7EDDD8;
      --border: #FFD4CC;
      --shadow: rgba(255, 107, 107, 0.15);
      --shadow-strong: rgba(255, 107, 107, 0.25);
    }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #FFE8E0 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .app {
      max-width: 100%;
      margin: 0 auto;
      padding-bottom: 80px;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: var(--bg-secondary);
      padding: 24px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px var(--shadow);
      border-bottom: 3px solid var(--accent);
    }
    
    .header h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent) 0%, #FF8E8E 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    /* Navigation */
    .nav {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .nav::-webkit-scrollbar {
      display: none;
    }
    
    .nav-btn {
      flex-shrink: 0;
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      color: var(--text-secondary);
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 25px;
    }
    
    .nav-btn.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      box-shadow: 0 4px 15px var(--shadow-strong);
      transform: translateY(-2px);
    }
    
    .nav-btn:active {
      transform: translateY(0);
    }
    
    /* Content */
    .content {
      padding: 20px;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Button styles */
    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border: none;
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow-strong);
    }
    
    .btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--accent);
      border: 2px solid var(--accent);
      box-shadow: none;
    }
    
    .btn-secondary:active {
      background: var(--bg-tertiary);
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 12px;
      width: auto;
      border-radius: 20px;
    }
    
    /* Form elements */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      border-radius: 12px;
      transition: all 0.3s;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--shadow);
    }
    
    textarea.form-input {
      resize: vertical;
      min-height: 80px;
      font-family: 'DM Sans', sans-serif;
    }
    
    /* Cards */
    .card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      padding: 20px;
      margin-bottom: 16px;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.1);
    }
    
    .card:active {
      transform: scale(0.99);
      box-shadow: 0 4px 20px var(--shadow-strong);
    }
    
    .card-title {
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    
    .card-meta {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    /* Exercise item */
    .exercise-item {
      background: var(--bg-tertiary);
      border-left: 4px solid var(--accent);
      padding: 14px;
      margin-bottom: 10px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .exercise-item:active {
      transform: translateX(4px);
    }
    
    .exercise-name {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    
    .exercise-rest {
      font-size: 12px;
      color: var(--success);
      font-weight: 600;
    }
    
    .exercise-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    /* Drag & Drop Exercise Reordering */
    .exercise-item-wrapper {
      display: flex;
      align-items: stretch;
      margin-bottom: 8px;
      border-radius: 8px;
      overflow: hidden;
    }

    .exercise-order-number {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      background: var(--accent);
      color: white;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 14px;
    }

    .exercise-content {
      flex: 1;
      background: var(--bg-tertiary);
      padding: 12px;
      font-size: 13px;
    }

    .exercise-drag-handle {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 16px;
      cursor: grab;
      user-select: none;
      transition: color 0.2s, background 0.2s;
      border-left: 1px solid var(--border);
    }

    .exercise-drag-handle:hover {
      color: var(--accent);
      background: var(--bg-secondary);
    }

    .exercise-drag-handle:active {
      cursor: grabbing;
    }

    .exercise-item-wrapper.dragging {
      opacity: 0.5;
    }

    .exercise-item-wrapper.drag-over {
      box-shadow: 0 -3px 0 0 var(--accent);
    }

    /* Workout tracker with Option B steppers */
    .tracker-exercise {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.1);
      overflow: hidden;
    }
    
    .tracker-exercise.current {
      border-color: var(--accent);
      box-shadow: 0 6px 30px var(--shadow-strong);
      border-width: 3px;
    }
    
    .tracker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .tracker-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .past-performance {
      background: var(--bg-tertiary);
      border: 2px dashed var(--border);
      padding: 14px;
      margin-bottom: 16px;
      border-radius: 12px;
    }
    
    .past-performance-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .past-performance-row {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pr-badge {
      background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
      color: #2D2D2D;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    
    /* Option B - Set row with steppers */
    .set-row {
      display: grid;
      grid-template-columns: 50px 1fr 80px;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .set-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
    }
    
    .set-inputs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
      overflow: hidden;
    }
    
    .input-with-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    
    .input-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .input-with-steppers {
      display: flex;
      align-items: center;
      gap: 4px;
      max-width: 100%;
      overflow: hidden;
    }
    
    .stepper-btn {
      width: 32px;
      height: 32px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--accent);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      flex-shrink: 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stepper-btn.double {
      font-size: 11px;
    }
    
    .stepper-btn:active {
      background: var(--accent);
      color: white;
      transform: scale(0.95);
    }
    
    .set-input {
      padding: 10px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      color: var(--text-primary);
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      text-align: center;
      font-weight: 700;
      border-radius: 10px;
      flex: 1;
      min-width: 0;
      transition: all 0.2s;
    }
    
    .set-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--shadow);
    }
    
    .set-input:disabled {
      opacity: 0.6;
      background: var(--bg-secondary);
    }
    
    .set-done {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
      color: white;
      padding: 12px;
      font-size: 12px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
      font-family: 'Poppins', sans-serif;
    }
    
    .set-done:active {
      transform: scale(0.95);
    }
    
    .set-done.completed {
      background: var(--bg-secondary);
      color: var(--success);
      border: 2px solid var(--success);
    }
    
    /* Timer */
    .rest-timer {
      background: linear-gradient(135deg, #E8FFF9 0%, #D4F8F0 100%);
      border: 3px solid var(--success);
      padding: 28px;
      text-align: center;
      margin-bottom: 20px;
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(78, 205, 196, 0.2);
    }
    
    .rest-timer-bg {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--success);
      opacity: 0.15;
      transition: width 1s linear;
    }
    
    .rest-timer-content {
      position: relative;
      z-index: 1;
    }
    
    .rest-timer-label {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .rest-timer-time {
      font-family: 'Poppins', sans-serif;
      font-size: 64px;
      font-weight: 800;
      color: var(--success);
      line-height: 1;
    }
    
    /* History styles */
    .history-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .history-filters::-webkit-scrollbar {
      display: none;
    }
    
    .filter-btn {
      flex-shrink: 0;
      padding: 10px 18px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 20px;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .history-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      padding: 18px;
      margin-bottom: 14px;
      border-radius: 14px;
      transition: all 0.2s;
    }
    
    .history-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .history-card-content {
      flex: 1;
      cursor: pointer;
    }
    
    .history-card-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      margin-left: 8px;
    }
    
    .icon-btn {
      width: 32px;
      height: 32px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .icon-btn:active {
      transform: scale(0.95);
    }
    
    .icon-btn.delete {
      color: #FF3B30;
      border-color: #FF3B30;
    }
    
    .icon-btn.delete:active {
      background: #FF3B30;
      color: white;
    }
    
    .history-date {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .history-title {
      font-family: 'Poppins', sans-serif;
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .history-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-tertiary);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .exercise-detail {
      background: var(--bg-tertiary);
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    
    .exercise-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .exercise-detail-title {
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .exercise-detail-sets {
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .progression-card {
      background: linear-gradient(135deg, #E8FFF9 0%, #D4F8F0 100%);
      border: 2px solid var(--success);
      padding: 16px;
      margin-bottom: 14px;
      border-radius: 14px;
    }
    
    .progression-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .progression-title {
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .progression-pr {
      background: var(--success);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .progression-list {
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.8;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 56px;
      margin-bottom: 16px;
      filter: grayscale(50%);
    }
    
    .empty-text {
      font-size: 16px;
      font-weight: 600;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 28px;
      width: 100%;
      max-width: 500px;
      margin-top: 20px;
      box-shadow: 0 10px 40px rgba(255, 107, 107, 0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
    }
    
    .modal-close {
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .modal-close:active {
      background: var(--accent);
      color: white;
    }
    
    /* Workout navigation */
    .workout-nav {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .workout-nav .btn {
      flex: 1;
    }

    /* Session buttons */
    .session-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    /* Delete button */
    .btn-delete {
      background: transparent;
      color: #FF3B30;
      border: 2px solid #FF3B30;
    }
    
    .btn-delete:active {
      background: #FF3B30;
      color: white;
    }
    
    /* Success message */
    .success-message {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
      color: white;
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-weight: 600;
      text-align: center;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .comparison-badge {
      display: inline-block;
      background: var(--success);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 8px;
    }
    
    .comparison-badge.negative {
          background: #FF8E8E;
        }
    
        /* Auth styles */
        .auth-container {
          max-width: 400px;
          margin: 100px auto;
          padding: 32px;
          background: var(--bg-secondary);
          border-radius: 20px;
          border: 2px solid var(--border);
          box-shadow: 0 10px 40px var(--shadow-strong);
        }
    
        .auth-title {
          font-family: 'Poppins', sans-serif;
          font-size: 32px;
          font-weight: 800;
          text-align: center;
          margin-bottom: 8px;
          background: linear-gradient(135deg, var(--accent) 0%, #FF8E8E 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }
    
        .auth-subtitle {
          text-align: center;
          color: var(--text-secondary);
          font-size: 14px;
          margin-bottom: 32px;
        }
    
        .auth-tabs {
          display: flex;
          gap: 8px;
          margin-bottom: 24px;
        }
    
        .auth-tab {
          flex: 1;
          padding: 12px;
          background: var(--bg-tertiary);
          border: 2px solid transparent;
          color: var(--text-secondary);
          font-weight: 600;
          cursor: pointer;
          border-radius: 12px;
          transition: all 0.2s;
          font-family: 'Poppins', sans-serif;
        }
    
        .auth-tab.active {
          background: var(--accent);
          color: white;
        }
    
        .auth-error {
          background: #FFE8E0;
          border: 2px solid var(--accent);
          color: var(--accent);
          padding: 12px;
          border-radius: 10px;
          margin-bottom: 16px;
          font-size: 13px;
          font-weight: 600;
        }
    
        .auth-footer {
          text-align: center;
          margin-top: 24px;
          font-size: 13px;
          color: var(--text-secondary);
        }
    
        .auth-link {
          color: var(--accent);
          font-weight: 600;
          cursor: pointer;
          text-decoration: underline;
        }
    
        .logout-btn {
          background: var(--bg-tertiary);
          border: 2px solid var(--border);
          color: var(--text-secondary);
          padding: 8px 16px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          border-radius: 20px;
          transition: all 0.2s;
          font-family: 'Poppins', sans-serif;
        }
    
        .logout-btn:active {
          background: var(--accent);
          color: white;
        }

    /* ===== RESPONSIVE MOBILE ===== */

    /* Tablettes et petits √©crans */
    @media (max-width: 768px) {
      .content {
        padding: 16px;
      }

      .header {
        padding: 20px 16px;
      }

      .header h1 {
        font-size: 28px;
      }

      .modal-content {
        padding: 20px;
        margin: 10px;
      }

      .modal-title {
        font-size: 20px;
      }
    }

    /* Mobile standard */
    @media (max-width: 480px) {
      .content {
        padding: 12px;
      }

      .header {
        padding: 16px 12px;
      }

      .header h1 {
        font-size: 24px;
      }

      .header-subtitle {
        font-size: 12px;
      }

      .nav-btn {
        padding: 10px 14px;
        font-size: 12px;
      }

      /* Tracker exercise card */
      .tracker-exercise {
        padding: 14px;
      }

      .tracker-title {
        font-size: 17px;
      }

      /* Set row - disposition verticale sur mobile */
      .set-row {
        grid-template-columns: 40px 1fr 60px;
        gap: 8px;
      }

      .set-label {
        font-size: 12px;
      }

      .set-inputs {
        gap: 6px;
      }

      /* Steppers plus petits */
      .input-with-steppers {
        gap: 3px;
      }

      .stepper-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
        border-radius: 6px;
      }

      .stepper-btn.double {
        font-size: 10px;
      }

      .set-input {
        padding: 8px 4px;
        font-size: 14px;
        min-width: 40px;
      }

      .set-done {
        padding: 8px 4px;
        font-size: 10px;
      }

      /* Boutons */
      .btn {
        padding: 14px 12px;
        font-size: 14px;
      }

      .btn-small {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* Cards */
      .card {
        padding: 16px;
      }

      .card-title {
        font-size: 16px;
      }

      .card-actions {
        flex-wrap: wrap;
      }

      .card-actions .btn {
        flex: 1 1 calc(50% - 4px);
        min-width: 0;
      }

      /* Exercise actions */
      .exercise-actions {
        flex-wrap: wrap;
      }

      .exercise-actions .btn-small {
        flex: 1 1 calc(50% - 3px);
        text-align: center;
      }

      /* Timer */
      .rest-timer {
        padding: 20px;
      }

      .rest-timer-time {
        font-size: 48px;
      }

      /* History */
      .history-stats {
        gap: 8px;
      }

      .stat-badge {
        padding: 4px 8px;
        font-size: 11px;
      }

      /* Past performance */
      .past-performance {
        padding: 10px;
      }

      .past-performance-row {
        font-size: 12px;
        flex-wrap: wrap;
        gap: 4px;
      }

      /* Workout nav buttons */
      .workout-nav {
        flex-wrap: wrap;
      }

      .workout-nav .btn {
        flex: 1;
        min-width: 100px;
      }

      /* Session buttons */
      .session-buttons .btn {
        font-size: 13px;
        padding: 12px;
      }

      /* Modal */
      .modal {
        padding: 10px;
      }

      .modal-content {
        padding: 16px;
        margin-top: 10px;
        border-radius: 16px;
      }

      .modal-title {
        font-size: 18px;
      }

      .form-input, .form-select {
        padding: 12px;
        font-size: 14px;
      }
    }

    /* Tr√®s petits √©crans (iPhone SE, etc.) */
    @media (max-width: 360px) {
      .content {
        padding: 10px;
      }

      .header h1 {
        font-size: 22px;
      }

      .nav-btn {
        padding: 8px 12px;
        font-size: 11px;
      }

      /* Set row encore plus compact */
      .set-row {
        grid-template-columns: 35px 1fr 50px;
        gap: 6px;
      }

      .set-label {
        font-size: 11px;
      }

      /* Cacher les boutons double sur tr√®s petit √©cran */
      .stepper-btn.double {
        display: none;
      }

      .stepper-btn {
        width: 26px;
        height: 26px;
        font-size: 11px;
      }

      .set-input {
        padding: 6px 2px;
        font-size: 13px;
      }

      .set-done {
        padding: 6px 2px;
        font-size: 9px;
      }

      .input-label {
        font-size: 9px;
      }

      .tracker-title {
        font-size: 15px;
      }

      .tracker-exercise {
        padding: 12px;
      }

      .btn {
        padding: 12px 10px;
        font-size: 13px;
      }

      .btn-small {
        padding: 5px 8px;
        font-size: 10px;
      }

      .rest-timer-time {
        font-size: 40px;
      }

      .card-actions .btn {
        font-size: 12px;
        padding: 10px 8px;
      }

      .exercise-item {
        padding: 10px;
      }

      .exercise-name {
        font-size: 14px;
      }
    }
      </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
      const SUPABASE_URL = 'https://wvogkaailuwqojhljhmv.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2b2drYWFpbHV3cW9qaGxqaG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTEwNzksImV4cCI6MjA4NDE2NzA3OX0.PfUsBawk-x3FWZL0BAe-_tRyveMUQor1bbYly5qIfQM';
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      const { useState, useEffect, useRef } = React;

    // Supabase utilities
    const db = {
      // Programmes
      async getPrograms(userId) {
        const { data, error } = await supabase
          .from('programs')
          .select(`
            *,
            sessions (
              *,
              exercises (*)
            )
          `)
          .eq('user_id', userId)
          .order('created_at', { ascending: true });
        
        if (error) {
          console.error('Error fetching programs:', error);
          return [];
        }
        
        return data.map(p => ({
          id: p.id,
          name: p.name,
          createdAt: new Date(p.created_at).getTime(),
          sessions: (p.sessions || []).map(s => ({
            id: s.id,
            name: s.name,
            exercises: (s.exercises || [])
              .sort((a, b) => (a.position ?? 0) - (b.position ?? 0))
              .map(e => ({
                id: e.id,
                name: e.name,
                sets: e.sets,
                restTime: e.rest_time,
                notes: e.notes,
                position: e.position ?? 0
              }))
          }))
        }));
      },
    
      async addProgram(userId, name) {
        const { data, error } = await supabase
          .from('programs')
          .insert({ user_id: userId, name })
          .select()
          .single();
        
        if (error) throw error;
        return data;
      },
    
      async deleteProgram(programId) {
        const { error } = await supabase
          .from('programs')
          .delete()
          .eq('id', programId);
        
        if (error) throw error;
      },
    
      async addSession(programId, name) {
        const { data, error } = await supabase
          .from('sessions')
          .insert({ program_id: programId, name })
          .select()
          .single();
        
        if (error) throw error;
        return data;
      },
    
      async deleteSession(sessionId) {
        const { error } = await supabase
          .from('sessions')
          .delete()
          .eq('id', sessionId);
        
        if (error) throw error;
      },
    
      async addExercise(sessionId, exerciseData) {
        // Calculer la prochaine position
        const { data: existingExercises } = await supabase
          .from('exercises')
          .select('position')
          .eq('session_id', sessionId)
          .order('position', { ascending: false })
          .limit(1);

        const nextPosition = existingExercises?.length > 0
          ? existingExercises[0].position + 1
          : 0;

        const { data, error } = await supabase
          .from('exercises')
          .insert({
            session_id: sessionId,
            name: exerciseData.name,
            sets: exerciseData.sets,
            rest_time: exerciseData.restTime,
            notes: exerciseData.notes,
            position: nextPosition
          })
          .select()
          .single();

        if (error) throw error;
        return data;
      },
    
      async updateExercise(exerciseId, exerciseData) {
        const { error } = await supabase
          .from('exercises')
          .update({
            name: exerciseData.name,
            sets: exerciseData.sets,
            rest_time: exerciseData.restTime,
            notes: exerciseData.notes
          })
          .eq('id', exerciseId);
        
        if (error) throw error;
      },
    
      async deleteExercise(exerciseId) {
        const { error } = await supabase
          .from('exercises')
          .delete()
          .eq('id', exerciseId);

        if (error) throw error;
      },

      async reorderExercises(exerciseIds) {
        // Met √† jour les positions de tous les exercices
        // exerciseIds est un tableau d'IDs dans le nouvel ordre
        for (let i = 0; i < exerciseIds.length; i++) {
          const { error } = await supabase
            .from('exercises')
            .update({ position: i })
            .eq('id', exerciseIds[i]);

          if (error) throw error;
        }
      },

      // Workout History
      async getWorkoutHistory(userId) {
        const { data, error } = await supabase
          .from('workout_history')
          .select('*')
          .eq('user_id', userId)
          .order('completed_at', { ascending: false });
        
        if (error) {
          console.error('Error fetching history:', error);
          return [];
        }
        
        return data.map(w => ({
          id: w.id,
          programId: w.program_id,
          programName: w.program_name,
          sessionId: w.session_id,
          sessionName: w.session_name,
          exercises: w.exercises,
          startedAt: new Date(w.started_at).getTime(),
          completedAt: new Date(w.completed_at).getTime(),
          duration: w.duration
        }));
      },
    
      async addWorkoutHistory(userId, workout) {
        const { error } = await supabase
          .from('workout_history')
          .insert({
            user_id: userId,
            program_id: workout.programId,
            program_name: workout.programName,
            session_id: workout.sessionId,
            session_name: workout.sessionName,
            exercises: workout.exercises,
            started_at: new Date(workout.startedAt).toISOString(),
            completed_at: new Date(workout.completedAt).toISOString(),
            duration: workout.duration
          });
        
        if (error) throw error;
      },
    
      async deleteWorkout(workoutId) {
        const { error } = await supabase
          .from('workout_history')
          .delete()
          .eq('id', workoutId);
        
        if (error) throw error;
      },
    
      async updateWorkout(workoutId, exercises) {
        const { error } = await supabase
          .from('workout_history')
          .update({ exercises })
          .eq('id', workoutId);
        
        if (error) throw error;
      }
    };
    
    // Auth utilities
    const auth = {
      async signUp(email, password) {
        const { data, error } = await supabase.auth.signUp({
          email,
          password
        });
        
        if (error) throw error;
        return data;
      },
    
      async signIn(email, password) {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) throw error;
        return data;
      },
    
      async signOut() {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
      },
    
      async getUser() {
        const { data: { user } } = await supabase.auth.getUser();
        return user;
      },
    
      onAuthStateChange(callback) {
        return supabase.auth.onAuthStateChange(callback);
      }
    };

    // Generate unique ID
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    // Format date
    const formatDate = (timestamp) => {
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (date.toDateString() === today.toDateString()) {
        return `Aujourd'hui √† ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else if (date.toDateString() === yesterday.toDateString()) {
        return `Hier √† ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    };

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState(() => {
        // Si un entra√Ænement est en cours, afficher la vue workout
        try {
          const saved = localStorage.getItem('gymtracker_active_workout');
          return saved ? 'workout' : 'programs';
        } catch (e) {
          return 'programs';
        }
      });
      const [programs, setPrograms] = useState([]);
      const [workoutHistory, setWorkoutHistory] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [modalType, setModalType] = useState('');
      const [currentProgram, setCurrentProgram] = useState(null);
      const [currentSession, setCurrentSession] = useState(null);
      const [currentExercise, setCurrentExercise] = useState(null);
      const [currentWorkout, setCurrentWorkout] = useState(null);
      const [activeWorkout, setActiveWorkout] = useState(() => {
        // Charger l'entra√Ænement en cours depuis localStorage au d√©marrage
        try {
          const saved = localStorage.getItem('gymtracker_active_workout');
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          return null;
        }
      });

      // Sauvegarder l'entra√Ænement en cours dans localStorage √† chaque modification
      useEffect(() => {
        if (activeWorkout) {
          localStorage.setItem('gymtracker_active_workout', JSON.stringify(activeWorkout));
        } else {
          localStorage.removeItem('gymtracker_active_workout');
        }
      }, [activeWorkout]);

      // Check auth on mount
      useEffect(() => {
        auth.getUser().then(user => {
          setUser(user);
          setLoading(false);
        });
    
        const { data: subscription } = auth.onAuthStateChange((event, session) => {
          setUser(session?.user ?? null);
        });
    
        return () => subscription?.subscription?.unsubscribe();
      }, []);
    
      // Load data when user changes
      useEffect(() => {
        if (user) {
          loadData();
        } else {
          setPrograms([]);
          setWorkoutHistory([]);
        }
      }, [user]);
    
      const loadData = async () => {
        if (!user) return;
        
        try {
          const [programsData, historyData] = await Promise.all([
            db.getPrograms(user.id),
            db.getWorkoutHistory(user.id)
          ]);
          
          setPrograms(programsData);
          setWorkoutHistory(historyData);
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Erreur lors du chargement des donn√©es');
        }
      };
    
      const openModal = (type, program = null, session = null, exercise = null, workout = null) => {
        setModalType(type);
        setCurrentProgram(program);
        setCurrentSession(session);
        setCurrentExercise(exercise);
        setCurrentWorkout(workout);
        setShowModal(true);
      };
    
      const closeModal = () => {
        setShowModal(false);
        setModalType('');
        setCurrentProgram(null);
        setCurrentSession(null);
        setCurrentExercise(null);
        setCurrentWorkout(null);
      };
    
      const addProgram = async (name) => {
        try {
          await db.addProgram(user.id, name);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la cr√©ation du programme');
        }
      };
    
      const deleteProgram = async (programId) => {
        if (confirm('Supprimer ce programme ?')) {
          try {
            await db.deleteProgram(programId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };
    
      const addSession = async (programId, name) => {
        try {
          await db.addSession(programId, name);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la cr√©ation de la s√©ance');
        }
      };
    
      const deleteSession = async (programId, sessionId) => {
        if (confirm('Supprimer cette s√©ance ?')) {
          try {
            await db.deleteSession(sessionId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };
    
      const addExercise = async (programId, sessionId, exerciseData) => {
        try {
          await db.addExercise(sessionId, exerciseData);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la cr√©ation de l\'exercice');
        }
      };
    
      const editExercise = async (programId, sessionId, exerciseId, exerciseData) => {
        try {
          await db.updateExercise(exerciseId, exerciseData);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la modification');
        }
      };
    
      const deleteExercise = async (programId, sessionId, exerciseId) => {
        if (confirm('Supprimer cet exercice ?')) {
          try {
            await db.deleteExercise(exerciseId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };

      const reorderExercises = async (sessionId, exerciseIds) => {
        try {
          await db.reorderExercises(exerciseIds);
          await loadData();
        } catch (error) {
          console.error('Error reordering exercises:', error);
          alert('Erreur lors de la r√©organisation des exercices');
        }
      };

      const startWorkout = (program, session) => {
        const workout = {
          program,
          session,
          exercises: session.exercises.map(ex => ({
            ...ex,
            sets: Array(ex.sets).fill(null).map(() => ({
              reps: '',
              weight: '',
              completed: false
            }))
          })),
          startedAt: Date.now()
        };
        setActiveWorkout(workout);
        setView('workout');
      };
    
      const endWorkout = async (workout) => {
        const completedWorkout = {
          programId: workout.program.id,
          programName: workout.program.name,
          sessionId: workout.session.id,
          sessionName: workout.session.name,
          exercises: workout.exercises,
          startedAt: workout.startedAt,
          completedAt: Date.now(),
          duration: calculateDuration(workout.startedAt, Date.now())
        };

        try {
          await db.addWorkoutHistory(user.id, completedWorkout);
        } catch (error) {
          console.error('Error saving workout:', error);
          alert('Erreur lors de la sauvegarde de l\'entra√Ænement');
          return;
        }

        // Toujours revenir √† l'√©cran principal, m√™me si loadData √©choue
        setActiveWorkout(null);
        setView('programs');

        try {
          await loadData();
        } catch (error) {
          console.error('Error reloading data:', error);
        }
      };

      const discardWorkout = () => {
        setActiveWorkout(null);
        setView('programs');
      };

      const deleteWorkout = async (workoutId) => {
        if (confirm('Supprimer cette s√©ance de l\'historique ?')) {
          try {
            await db.deleteWorkout(workoutId);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };
    
      const deleteHistoryExercise = async (workoutId, exerciseId) => {
        if (confirm('Supprimer cet exercice de l\'historique ?')) {
          try {
            const workout = workoutHistory.find(w => w.id === workoutId);
            const updatedExercises = workout.exercises.filter(e => e.id !== exerciseId);
            await db.updateWorkout(workoutId, updatedExercises);
            await loadData();
          } catch (error) {
            alert('Erreur lors de la suppression');
          }
        }
      };
    
      const editHistoryExercise = async (workoutId, exerciseId, updatedSets) => {
        try {
          const workout = workoutHistory.find(w => w.id === workoutId);
          const updatedExercises = workout.exercises.map(e =>
            e.id === exerciseId ? { ...e, sets: updatedSets } : e
          );
          await db.updateWorkout(workoutId, updatedExercises);
          await loadData();
          closeModal();
        } catch (error) {
          alert('Erreur lors de la modification');
        }
      };
    
      if (loading) {
        return (
          <div className="app">
            <div className="empty-state">
              <div className="empty-icon">‚è≥</div>
              <div className="empty-text">Chargement...</div>
            </div>
          </div>
        );
      }
    
      if (!user) {
        return <AuthScreen />;
      }
    
      return (
        <div className="app">
          <header className="header">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
              <div>
                <h1>GymTracker</h1>
                <div className="header-subtitle">Ton coach personnel üí™</div>
              </div>
              <button 
                className="logout-btn"
                onClick={async () => {
                  if (confirm('Se d√©connecter ?')) {
                    await auth.signOut();
                  }
                }}
              >
                D√©connexion
              </button>
            </div>
            <nav className="nav">
              <button 
                className={`nav-btn ${view === 'programs' ? 'active' : ''}`}
                onClick={() => setView('programs')}
              >
                Programmes
              </button>
              <button 
                className={`nav-btn ${view === 'workout' ? 'active' : ''}`}
                onClick={() => setView('workout')}
              >
                Entra√Ænement
              </button>
              <button 
                className={`nav-btn ${view === 'history' ? 'active' : ''}`}
                onClick={() => setView('history')}
              >
                Historique
              </button>
            </nav>
          </header>
    
          <div className="content">
            {view === 'programs' && (
              <ProgramsView
                programs={programs}
                onAddProgram={() => openModal('program')}
                onDeleteProgram={deleteProgram}
                onAddSession={(program) => openModal('session', program)}
                onDeleteSession={deleteSession}
                onAddExercise={(program, session) => openModal('exercise', program, session)}
                onEditExercise={(program, session, exercise) => openModal('edit-exercise', program, session, exercise)}
                onDeleteExercise={deleteExercise}
                onReorderExercises={reorderExercises}
                onStartWorkout={startWorkout}
              />
            )}
    
            {view === 'workout' && (
              <WorkoutView 
                workout={activeWorkout}
                workoutHistory={workoutHistory}
                onUpdateWorkout={setActiveWorkout}
                onEndWorkout={endWorkout}
                onDiscardWorkout={discardWorkout}
              />
            )}
    
            {view === 'history' && (
              <HistoryView 
                history={workoutHistory}
                programs={programs}
                onDeleteWorkout={deleteWorkout}
                onDeleteExercise={deleteHistoryExercise}
                onEditExercise={(workout, exercise) => openModal('edit-history-exercise', null, null, exercise, workout)}
              />
            )}
          </div>
    
          {showModal && (
            <Modal
              type={modalType}
              program={currentProgram}
              session={currentSession}
              exercise={currentExercise}
              workout={currentWorkout}
              onClose={closeModal}
              onAddProgram={addProgram}
              onAddSession={addSession}
              onAddExercise={addExercise}
              onEditExercise={editExercise}
              onEditHistoryExercise={editHistoryExercise}
            />
          )}
        </div>
      );
    }
    
    const calculateDuration = (start, end) => {
      return Math.round((end - start) / 60000);
    };
    
    function AuthScreen() {
      const [mode, setMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
    
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
    
        try {
          if (mode === 'login') {
            await auth.signIn(email, password);
          } else {
            await auth.signUp(email, password);
            alert('Compte cr√©√© ! Vous pouvez maintenant vous connecter.');
            setMode('login');
          }
        } catch (err) {
          setError(err.message || 'Une erreur est survenue');
        } finally {
          setLoading(false);
        }
      };
    
      return (
        <div className="auth-container">
          <h1 className="auth-title">GymTracker</h1>
          <div className="auth-subtitle">Ton coach personnel üí™</div>
    
          <div className="auth-tabs">
            <button 
              className={`auth-tab ${mode === 'login' ? 'active' : ''}`}
              onClick={() => setMode('login')}
            >
              Connexion
            </button>
            <button 
              className={`auth-tab ${mode === 'signup' ? 'active' : ''}`}
              onClick={() => setMode('signup')}
            >
              Inscription
            </button>
          </div>
    
          {error && (
            <div className="auth-error">{error}</div>
          )}
    
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label className="form-label">Email</label>
              <input
                type="email"
                className="form-input"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                autoFocus
              />
            </div>
    
            <div className="form-group">
              <label className="form-label">Mot de passe</label>
              <input
                type="password"
                className="form-input"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                minLength="6"
              />
            </div>
    
            <button type="submit" className="btn" disabled={loading}>
              {loading ? 'Chargement...' : mode === 'login' ? 'Se connecter' : 'Cr√©er un compte'}
            </button>
          </form>
    
          {mode === 'login' && (
            <div className="auth-footer">
              Pas encore de compte ?{' '}
              <span className="auth-link" onClick={() => setMode('signup')}>
                Inscris-toi
              </span>
            </div>
          )}
        </div>
      );
    }
    function ProgramsView({ programs, onAddProgram, onDeleteProgram, onAddSession, onDeleteSession, onAddExercise, onEditExercise, onDeleteExercise, onReorderExercises, onStartWorkout }) {
      const [expandedProgram, setExpandedProgram] = useState(null);
      const [expandedSession, setExpandedSession] = useState(null);
      const [draggedExercise, setDraggedExercise] = useState(null);

      const handleDragStart = (e, exercise, sessionId) => {
        setDraggedExercise({ exercise, sessionId });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', exercise.id);
        setTimeout(() => {
          e.target.closest('.exercise-item-wrapper')?.classList.add('dragging');
        }, 0);
      };

      const handleDragEnd = (e) => {
        e.target.closest('.exercise-item-wrapper')?.classList.remove('dragging');
        setDraggedExercise(null);
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      const handleDragEnter = (e, exercise) => {
        e.preventDefault();
        const wrapper = e.target.closest('.exercise-item-wrapper');
        if (wrapper && draggedExercise?.exercise.id !== exercise.id) {
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
          wrapper.classList.add('drag-over');
        }
      };

      const handleDragLeave = (e) => {
        const wrapper = e.target.closest('.exercise-item-wrapper');
        const relatedTarget = e.relatedTarget?.closest('.exercise-item-wrapper');
        if (wrapper && wrapper !== relatedTarget) {
          wrapper.classList.remove('drag-over');
        }
      };

      const handleDrop = (e, targetExercise, session) => {
        e.preventDefault();
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

        if (!draggedExercise || draggedExercise.sessionId !== session.id) return;
        if (draggedExercise.exercise.id === targetExercise.id) return;

        const exercises = [...session.exercises];
        const draggedIndex = exercises.findIndex(ex => ex.id === draggedExercise.exercise.id);
        const targetIndex = exercises.findIndex(ex => ex.id === targetExercise.id);

        if (draggedIndex === -1 || targetIndex === -1) return;

        const [removed] = exercises.splice(draggedIndex, 1);
        exercises.splice(targetIndex, 0, removed);

        const newOrder = exercises.map(ex => ex.id);
        onReorderExercises(session.id, newOrder);

        setDraggedExercise(null);
      };

      if (programs.length === 0) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon">üí™</div>
              <div className="empty-text">Cr√©e ton premier programme !</div>
            </div>
            <button className="btn" onClick={onAddProgram}>
              + Cr√©er un programme
            </button>
          </div>
        );
      }

      return (
        <div className="view active">
          {programs.map(program => (
            <div key={program.id} className="card">
              <div onClick={() => setExpandedProgram(expandedProgram === program.id ? null : program.id)}>
                <div className="card-title">{program.name}</div>
                <div className="card-meta">
                  {program.sessions.length} s√©ance{program.sessions.length > 1 ? 's' : ''}
                </div>
              </div>

              {expandedProgram === program.id && (
                <div style={{ marginTop: '16px' }}>
                  {program.sessions.map(session => (
                    <div key={session.id} style={{ marginBottom: '12px' }}>
                      <div 
                        className="exercise-item"
                        onClick={() => setExpandedSession(expandedSession === session.id ? null : session.id)}
                      >
                        <div className="exercise-name">{session.name}</div>
                        <div className="exercise-rest">
                          {session.exercises.length} exercice{session.exercises.length > 1 ? 's' : ''}
                        </div>
                      </div>

                      {expandedSession === session.id && (
                        <div style={{ marginTop: '8px', paddingLeft: '8px' }}>
                          {session.exercises.map((exercise, index) => (
                            <div
                              key={exercise.id}
                              className="exercise-item-wrapper"
                              draggable="true"
                              onDragStart={(e) => handleDragStart(e, exercise, session.id)}
                              onDragEnd={handleDragEnd}
                              onDragOver={handleDragOver}
                              onDragEnter={(e) => handleDragEnter(e, exercise)}
                              onDragLeave={handleDragLeave}
                              onDrop={(e) => handleDrop(e, exercise, session)}
                            >
                              <div className="exercise-order-number">{index + 1}</div>
                              <div className="exercise-content">
                                <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>{exercise.name}</div>
                                <div style={{ color: 'var(--text-secondary)', fontSize: '12px', marginBottom: '8px' }}>
                                  {exercise.sets} s√©ries ‚Ä¢ Repos: {exercise.restTime}s
                                </div>
                                {exercise.notes && (
                                  <div style={{
                                    fontSize: '12px',
                                    fontStyle: 'italic',
                                    color: 'var(--text-secondary)',
                                    marginBottom: '8px',
                                    paddingLeft: '8px',
                                    borderLeft: '2px solid var(--border)'
                                  }}>
                                    {exercise.notes}
                                  </div>
                                )}
                                <div className="exercise-actions">
                                  <button
                                    className="btn-small btn-secondary"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onEditExercise(program, session, exercise);
                                    }}
                                  >
                                    Modifier
                                  </button>
                                  <button
                                    className="btn-small btn-delete"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onDeleteExercise(program.id, session.id, exercise.id);
                                    }}
                                  >
                                    Supprimer
                                  </button>
                                </div>
                              </div>
                              <div className="exercise-drag-handle" title="Glisser pour r√©ordonner">‚ò∞</div>
                            </div>
                          ))}
                          <div className="session-buttons">
                            <button
                              className="btn btn-secondary"
                              onClick={() => onAddExercise(program, session)}
                            >
                              + Ajouter un exercice
                            </button>
                            <button
                              className="btn"
                              onClick={() => onStartWorkout(program, session)}
                            >
                              üèãÔ∏è D√©marrer cette s√©ance
                            </button>
                            <button
                              className="btn btn-delete"
                              onClick={() => onDeleteSession(program.id, session.id)}
                            >
                              Supprimer la s√©ance
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}

                  <div className="card-actions">
                    <button 
                      className="btn btn-secondary"
                      onClick={() => onAddSession(program)}
                    >
                      + Nouvelle s√©ance
                    </button>
                    <button 
                      className="btn btn-delete"
                      onClick={() => onDeleteProgram(program.id)}
                    >
                      Supprimer
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}

          <button className="btn" style={{ marginTop: '20px' }} onClick={onAddProgram}>
            + Nouveau Programme
          </button>
        </div>
      );
    }

    function WorkoutView({ workout, workoutHistory, onUpdateWorkout, onEndWorkout, onDiscardWorkout }) {
      const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
      const [restTimer, setRestTimer] = useState(null);
      const [restRemaining, setRestRemaining] = useState(0);
      const [showSuccess, setShowSuccess] = useState(false);
      const [showEndModal, setShowEndModal] = useState(false);
      const timerRef = useRef(null);

      useEffect(() => {
        if (restTimer !== null) {
          const startTime = Date.now();
          const endTime = startTime + restTimer * 1000;

          timerRef.current = setInterval(() => {
            const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
            setRestRemaining(remaining);

            if (remaining === 0) {
              clearInterval(timerRef.current);
              setRestTimer(null);
              if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
              }
            }
          }, 100);

          return () => clearInterval(timerRef.current);
        }
      }, [restTimer]);

      if (!workout) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon">üèãÔ∏è</div>
              <div className="empty-text">S√©lectionne une s√©ance pour commencer</div>
            </div>
          </div>
        );
      }

      const currentExercise = workout.exercises[currentExerciseIndex];

      // Find last performance and PR for this exercise
      const getExercisePerformances = (exerciseName) => {
        const performances = [];
        let maxWeight = 0;
        let maxReps = 0;
        const prs = [];

        for (let i = 0; i < workoutHistory.length; i++) {
          const historyWorkout = workoutHistory[i];
          const exerciseData = historyWorkout.exercises.find(e => e.name === exerciseName);
          if (exerciseData) {
            const completedSets = exerciseData.sets.filter(s => s.completed);
            if (completedSets.length > 0) {
              if (performances.length === 0) {
                // This is the last performance
                performances.push({ type: 'last', sets: completedSets });
              }
              
              // Check for PRs
              completedSets.forEach((set, idx) => {
                const weight = parseFloat(set.weight) || 0;
                const reps = parseInt(set.reps) || 0;
                
                if (!prs[idx] || weight > (parseFloat(prs[idx].weight) || 0) || 
                    (weight === parseFloat(prs[idx].weight) && reps > (parseInt(prs[idx].reps) || 0))) {
                  prs[idx] = set;
                  if (weight > maxWeight || (weight === maxWeight && reps > maxReps)) {
                    maxWeight = weight;
                    maxReps = reps;
                  }
                }
              });
            }
          }
        }

        return { last: performances[0]?.sets || null, prs };
      };

      const { last: lastPerformance, prs: prSets } = getExercisePerformances(currentExercise.name);

      // Auto-fill from last performance on mount
      useEffect(() => {
        if (lastPerformance && currentExercise.sets.every(s => !s.reps && !s.weight)) {
          const updated = { ...workout };
          lastPerformance.forEach((lastSet, idx) => {
            if (updated.exercises[currentExerciseIndex].sets[idx]) {
              updated.exercises[currentExerciseIndex].sets[idx].reps = lastSet.reps;
              updated.exercises[currentExerciseIndex].sets[idx].weight = lastSet.weight;
            }
          });
          onUpdateWorkout(updated);
        }
      }, [currentExerciseIndex]);

      const updateSet = (setIndex, field, value) => {
        const updated = { ...workout };
        updated.exercises[currentExerciseIndex].sets[setIndex][field] = value;
        onUpdateWorkout(updated);
      };

      const adjustWeight = (setIndex, delta) => {
        const updated = { ...workout };
        const currentValue = parseFloat(updated.exercises[currentExerciseIndex].sets[setIndex].weight) || 0;
        const newValue = Math.max(0, currentValue + delta);
        updated.exercises[currentExerciseIndex].sets[setIndex].weight = newValue.toString();
        onUpdateWorkout(updated);
      };

      const completeSet = (setIndex) => {
        const updated = { ...workout };
        const set = updated.exercises[currentExerciseIndex].sets[setIndex];
        set.completed = !set.completed;
        
        if (set.completed && currentExercise.restTime) {
          setRestTimer(currentExercise.restTime);
          
          // Check if PR
          const prSet = prSets[setIndex];
          if (prSet) {
            const isPR = parseFloat(set.weight) > parseFloat(prSet.weight) ||
                        (parseFloat(set.weight) === parseFloat(prSet.weight) && 
                         parseInt(set.reps) > parseInt(prSet.reps));
            
            if (isPR) {
              setShowSuccess(true);
              setTimeout(() => setShowSuccess(false), 3000);
            }
          } else if (set.reps && set.weight) {
            // First time doing this exercise
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
          }
        }
        
        onUpdateWorkout(updated);
      };

      const skipRestTimer = () => {
        clearInterval(timerRef.current);
        setRestTimer(null);
        setRestRemaining(0);
      };

      const getComparison = (setIndex) => {
        if (!lastPerformance || !lastPerformance[setIndex]) return null;
        
        const currentSet = currentExercise.sets[setIndex];
        const lastSet = lastPerformance[setIndex];
        
        if (!currentSet.completed || !currentSet.reps || !currentSet.weight) return null;
        
        const weightDiff = parseFloat(currentSet.weight) - parseFloat(lastSet.weight);
        const repsDiff = parseInt(currentSet.reps) - parseInt(lastSet.reps);
        
        if (weightDiff > 0) {
          return { text: `+${weightDiff}kg`, positive: true };
        } else if (weightDiff === 0 && repsDiff > 0) {
          return { text: `+${repsDiff} reps`, positive: true };
        } else if (weightDiff < 0) {
          return { text: `${weightDiff}kg`, positive: false };
        } else if (repsDiff < 0) {
          return { text: `${repsDiff} reps`, positive: false };
        }
        return null;
      };

      return (
        <div className="view active">
          <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontWeight: '600' }}>
                {workout.program.name} ‚Üí {workout.session.name}
              </div>
              <div style={{ fontSize: '22px', fontWeight: '700', marginTop: '4px', fontFamily: 'Poppins' }}>
                Exercice {currentExerciseIndex + 1}/{workout.exercises.length}
              </div>
            </div>
            <button className="btn-small btn-delete" onClick={() => setShowEndModal(true)}>
              Terminer
            </button>
          </div>

          {/* Modal de fin d'entra√Ænement */}
          {showEndModal && (
            <div className="modal active" onClick={() => setShowEndModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 className="modal-title">Terminer l'entra√Ænement ?</h2>
                  <button className="modal-close" onClick={() => setShowEndModal(false)}>‚úï</button>
                </div>
                <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>
                  Que souhaitez-vous faire avec cet entra√Ænement ?
                </p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <button
                    className="btn"
                    onClick={() => {
                      setShowEndModal(false);
                      onEndWorkout(workout);
                    }}
                  >
                    ‚úì Enregistrer dans l'historique
                  </button>
                  <button
                    className="btn btn-delete"
                    onClick={() => {
                      setShowEndModal(false);
                      onDiscardWorkout();
                    }}
                  >
                    üóëÔ∏è Supprimer sans enregistrer
                  </button>
                  <button
                    className="btn btn-secondary"
                    onClick={() => setShowEndModal(false)}
                  >
                    Continuer l'entra√Ænement
                  </button>
                </div>
              </div>
            </div>
          )}

          {showSuccess && (
            <div className="success-message">
              üéâ Nouveau record personnel !
            </div>
          )}

          {restTimer !== null && (
            <div className="rest-timer">
              <div className="rest-timer-bg" style={{ width: `${(restRemaining / restTimer) * 100}%` }}></div>
              <div className="rest-timer-content">
                <div className="rest-timer-label">Temps de repos</div>
                <div className="rest-timer-time">{restRemaining}s</div>
                <button className="btn-small btn-secondary" style={{ marginTop: '12px' }} onClick={skipRestTimer}>
                  Passer
                </button>
              </div>
            </div>
          )}

          <div className="tracker-exercise current">
            <div className="tracker-header">
              <div className="tracker-title">{currentExercise.name}</div>
            </div>

            {currentExercise.notes && (
              <div style={{ 
                background: 'var(--bg-tertiary)', 
                padding: '12px', 
                borderRadius: '12px',
                marginBottom: '16px',
                fontSize: '13px',
                fontStyle: 'italic',
                color: 'var(--text-secondary)'
              }}>
                üìù {currentExercise.notes}
              </div>
            )}

            {(lastPerformance || prSets.length > 0) && (
              <div className="past-performance">
                <div className="past-performance-title">Performances Pass√©es</div>
                {currentExercise.sets.map((_, idx) => {
                  const lastSet = lastPerformance?.[idx];
                  const prSet = prSets[idx];
                  const isPR = lastSet && prSet && 
                               parseFloat(lastSet.weight) === parseFloat(prSet.weight) &&
                               parseInt(lastSet.reps) === parseInt(prSet.reps);
                  
                  if (!lastSet && !prSet) return null;
                  
                  return (
                    <div key={idx} className="past-performance-row">
                      <span>
                        S{idx + 1}: {lastSet ? `${lastSet.reps} √ó ${lastSet.weight}kg` : '-'}
                      </span>
                      {isPR ? (
                        <span className="pr-badge">üèÜ PR</span>
                      ) : prSet && lastSet && (parseFloat(prSet.weight) !== parseFloat(lastSet.weight) || parseInt(prSet.reps) !== parseInt(lastSet.reps)) ? (
                        <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                          Record: {prSet.reps} √ó {prSet.weight}kg
                        </span>
                      ) : null}
                    </div>
                  );
                })}
              </div>
            )}

            {currentExercise.sets.map((set, idx) => {
              const comparison = getComparison(idx);
              return (
                <div key={idx}>
                  <div className="set-row">
                    <div className="set-label">S{idx + 1}</div>
                    <div className="set-inputs">
                      <div className="input-with-label">
                        <div className="input-label">Reps</div>
                        <input
                          type="number"
                          inputMode="numeric"
                          className="set-input"
                          placeholder="0"
                          value={set.reps}
                          onChange={(e) => updateSet(idx, 'reps', e.target.value)}
                          disabled={set.completed}
                        />
                      </div>
                      <div className="input-with-label">
                        <div className="input-label">Poids (kg)</div>
                        <div className="input-with-steppers">
                          <button 
                            className="stepper-btn double" 
                            onClick={() => adjustWeight(idx, -5)}
                            disabled={set.completed}
                          >
                            --
                          </button>
                          <button 
                            className="stepper-btn" 
                            onClick={() => adjustWeight(idx, -2.5)}
                            disabled={set.completed}
                          >
                            -
                          </button>
                          <input
                            type="number"
                            inputMode="decimal"
                            className="set-input"
                            placeholder="0"
                            value={set.weight}
                            onChange={(e) => updateSet(idx, 'weight', e.target.value)}
                            disabled={set.completed}
                          />
                          <button 
                            className="stepper-btn" 
                            onClick={() => adjustWeight(idx, 2.5)}
                            disabled={set.completed}
                          >
                            +
                          </button>
                          <button 
                            className="stepper-btn double" 
                            onClick={() => adjustWeight(idx, 5)}
                            disabled={set.completed}
                          >
                            ++
                          </button>
                        </div>
                      </div>
                    </div>
                    <button
                      className={`set-done ${set.completed ? 'completed' : ''}`}
                      onClick={() => completeSet(idx)}
                    >
                      {set.completed ? '‚úì' : 'Fait'}
                    </button>
                  </div>
                  {comparison && (
                    <div style={{ marginBottom: '12px', fontSize: '12px', textAlign: 'center' }}>
                      <span className={`comparison-badge ${comparison.positive ? '' : 'negative'}`}>
                        {comparison.text}
                      </span>
                    </div>
                  )}
                </div>
              );
            })}

            <div className="workout-nav">
              {currentExerciseIndex > 0 && (
                <button
                  className="btn btn-secondary"
                  onClick={() => setCurrentExerciseIndex(currentExerciseIndex - 1)}
                >
                  ‚Üê Pr√©c.
                </button>
              )}
              {currentExerciseIndex < workout.exercises.length - 1 && (
                <button
                  className="btn"
                  onClick={() => setCurrentExerciseIndex(currentExerciseIndex + 1)}
                >
                  Suivant ‚Üí
                </button>
              )}
            </div>
          </div>

          <div style={{ marginTop: '24px' }}>
            <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '12px', fontWeight: '600' }}>
              Exercices suivants
            </div>
            {workout.exercises.map((ex, idx) => (
              idx !== currentExerciseIndex && (
                <div 
                  key={idx}
                  className="exercise-item"
                  onClick={() => setCurrentExerciseIndex(idx)}
                  style={{ cursor: 'pointer', opacity: idx < currentExerciseIndex ? 0.6 : 1 }}
                >
                  <div className="exercise-name">
                    {idx < currentExerciseIndex ? '‚úì ' : ''}{ex.name}
                  </div>
                  <div className="exercise-rest">
                    {ex.sets.filter(s => s.completed).length}/{ex.sets.length} s√©ries
                  </div>
                </div>
              )
            ))}
          </div>
        </div>
      );
    }

    function HistoryView({ history, programs, onDeleteWorkout, onDeleteExercise, onEditExercise }) {
      const [filter, setFilter] = useState('all');
      const [expandedWorkout, setExpandedWorkout] = useState(null);
      const [viewMode, setViewMode] = useState('sessions');
      const [selectedExercise, setSelectedExercise] = useState(null);

      const getAllExercises = () => {
        const exercises = new Set();
        history.forEach(workout => {
          workout.exercises.forEach(ex => {
            exercises.add(ex.name);
          });
        });
        return Array.from(exercises);
      };

      const allExercises = getAllExercises();

      const filteredHistory = filter === 'all' 
        ? history 
        : history.filter(w => w.programId === filter);

      const getExerciseHistory = (exerciseName) => {
        return history
          .map(workout => ({
            ...workout,
            exerciseData: workout.exercises.find(e => e.name === exerciseName)
          }))
          .filter(w => w.exerciseData)
          .map(w => ({
            date: w.completedAt,
            sets: w.exerciseData.sets.filter(s => s.completed)
          }));
      };

      const getPersonalRecord = (exerciseName) => {
        const exerciseHistory = getExerciseHistory(exerciseName);
        let maxWeight = 0;
        let maxReps = 0;
        
        exerciseHistory.forEach(({ sets }) => {
          sets.forEach(set => {
            const weight = parseFloat(set.weight) || 0;
            const reps = parseInt(set.reps) || 0;
            if (weight > maxWeight || (weight === maxWeight && reps > maxReps)) {
              maxWeight = weight;
              maxReps = reps;
            }
          });
        });
        
        return maxWeight > 0 ? `${maxWeight}kg √ó ${maxReps}` : null;
      };

      if (history.length === 0) {
        return (
          <div className="view active">
            <div className="empty-state">
              <div className="empty-icon">üìä</div>
              <div className="empty-text">Aucun entra√Ænement enregistr√©</div>
            </div>
          </div>
        );
      }

      return (
        <div className="view active">
          <div className="history-filters">
            <button 
              className={`filter-btn ${viewMode === 'sessions' ? 'active' : ''}`}
              onClick={() => setViewMode('sessions')}
            >
              üìÖ S√©ances
            </button>
            <button 
              className={`filter-btn ${viewMode === 'exercises' ? 'active' : ''}`}
              onClick={() => setViewMode('exercises')}
            >
              üèãÔ∏è Exercices
            </button>
          </div>

          {viewMode === 'sessions' && (
            <>
              <div className="history-filters">
                <button 
                  className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                  onClick={() => setFilter('all')}
                >
                  Tout
                </button>
                {programs.map(program => (
                  <button 
                    key={program.id}
                    className={`filter-btn ${filter === program.id ? 'active' : ''}`}
                    onClick={() => setFilter(program.id)}
                  >
                    {program.name}
                  </button>
                ))}
              </div>

              {filteredHistory.map(workout => (
                <div key={workout.id} className="history-card">
                  <div className="history-card-header">
                    <div 
                      className="history-card-content"
                      onClick={() => setExpandedWorkout(expandedWorkout === workout.id ? null : workout.id)}
                    >
                      <div className="history-date">{formatDate(workout.completedAt)}</div>
                      <div className="history-title">{workout.sessionName}</div>
                      <div className="history-stats">
                        <div className="stat-badge">‚è±Ô∏è {workout.duration} min</div>
                        <div className="stat-badge">üí™ {workout.exercises.length} exercices</div>
                      </div>
                    </div>
                    <div className="history-card-actions">
                      <button 
                        className="icon-btn delete"
                        onClick={(e) => {
                          e.stopPropagation();
                          onDeleteWorkout(workout.id);
                        }}
                        title="Supprimer la s√©ance"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>

                  {expandedWorkout === workout.id && (
                    <div style={{ marginTop: '12px' }}>
                      {workout.exercises.map((exercise, idx) => {
                        const completedSets = exercise.sets.filter(s => s.completed);
                        return (
                          <div key={idx} className="exercise-detail">
                            <div className="exercise-detail-header">
                              <div className="exercise-detail-title">{exercise.name}</div>
                              <div style={{ display: 'flex', gap: '6px' }}>
                                <button 
                                  className="icon-btn"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onEditExercise(workout, exercise);
                                  }}
                                  title="Modifier"
                                >
                                  ‚úèÔ∏è
                                </button>
                                <button 
                                  className="icon-btn delete"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onDeleteExercise(workout.id, exercise.id);
                                  }}
                                  title="Supprimer"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                            <div className="exercise-detail-sets">
                              {completedSets.map((set, sidx) => (
                                <div key={sidx}>
                                  S{sidx + 1}: {set.reps} reps √ó {set.weight}kg
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              ))}
            </>
          )}

          {viewMode === 'exercises' && (
            <>
              {allExercises.map(exerciseName => {
                const exerciseHistory = getExerciseHistory(exerciseName);
                const pr = getPersonalRecord(exerciseName);
                const isExpanded = selectedExercise === exerciseName;
                
                return (
                  <div key={exerciseName} className="progression-card">
                    <div onClick={() => setSelectedExercise(isExpanded ? null : exerciseName)}>
                      <div className="progression-header">
                        <div className="progression-title">{exerciseName}</div>
                        {pr && <div className="progression-pr">PR: {pr}</div>}
                      </div>
                      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontWeight: '600' }}>
                        {exerciseHistory.length} s√©ance{exerciseHistory.length > 1 ? 's' : ''}
                      </div>
                    </div>

                    {isExpanded && (
                      <div className="progression-list" style={{ marginTop: '12px' }}>
                        {exerciseHistory.slice(0, 5).map((session, idx) => (
                          <div key={idx} style={{ marginBottom: '8px', paddingBottom: '8px', borderBottom: '1px solid var(--border)' }}>
                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '4px' }}>
                              {formatDate(session.date)}
                            </div>
                            {session.sets.map((set, sidx) => (
                              <div key={sidx}>
                                S{sidx + 1}: {set.reps} reps √ó {set.weight}kg
                              </div>
                            ))}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </>
          )}
        </div>
      );
    }

    function Modal({ type, program, session, exercise, workout, onClose, onAddProgram, onAddSession, onAddExercise, onEditExercise, onEditHistoryExercise }) {
      const [formData, setFormData] = useState({
        name: exercise?.name || '',
        sets: exercise?.sets?.toString() || '3',
        restTime: exercise?.restTime?.toString() || '90',
        notes: exercise?.notes || ''
      });

      const [historySets, setHistorySets] = useState(
        Array.isArray(exercise?.sets) 
          ? exercise.sets.filter(s => s.completed).map((s, idx) => ({
              index: idx,
              reps: s.reps,
              weight: s.weight
            }))
          : []
      );

      const handleSubmit = (e) => {
        e.preventDefault();
        
        if (type === 'program') {
          onAddProgram(formData.name);
        } else if (type === 'session') {
          onAddSession(program.id, formData.name);
        } else if (type === 'exercise') {
          onAddExercise(program.id, session.id, {
            name: formData.name,
            sets: parseInt(formData.sets),
            restTime: parseInt(formData.restTime),
            notes: formData.notes
          });
        } else if (type === 'edit-exercise') {
          onEditExercise(program.id, session.id, exercise.id, {
            name: formData.name,
            sets: parseInt(formData.sets),
            restTime: parseInt(formData.restTime),
            notes: formData.notes
          });
        } else if (type === 'edit-history-exercise') {
          const updatedSets = exercise.sets.map((set, idx) => {
            const historySet = historySets.find(s => s.index === idx);
            if (set.completed && historySet) {
              return { ...set, reps: historySet.reps, weight: historySet.weight };
            }
            return set;
          });
          onEditHistoryExercise(workout.id, exercise.id, updatedSets);
        }
      };

      const updateHistorySet = (index, field, value) => {
        setHistorySets(historySets.map(s => 
          s.index === index ? { ...s, [field]: value } : s
        ));
      };

      return (
        <div className="modal active" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">
                {type === 'program' && 'Nouveau Programme'}
                {type === 'session' && 'Nouvelle S√©ance'}
                {type === 'exercise' && 'Nouvel Exercice'}
                {type === 'edit-exercise' && 'Modifier Exercice'}
                {type === 'edit-history-exercise' && 'Modifier Performance'}
              </h2>
              <button className="modal-close" onClick={onClose}>‚úï</button>
            </div>

            <form onSubmit={handleSubmit}>
              {type === 'edit-history-exercise' ? (
                <>
                  <div style={{ marginBottom: '16px', fontSize: '15px', fontWeight: '600' }}>
                    {exercise.name}
                  </div>
                  {historySets.map((set) => (
                    <div key={set.index} style={{ marginBottom: '12px' }}>
                      <div style={{ fontSize: '13px', fontWeight: '600', marginBottom: '6px' }}>
                        S√©rie {set.index + 1}
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <div style={{ flex: 1 }}>
                          <label className="form-label">Reps</label>
                          <input
                            type="number"
                            className="form-input"
                            value={set.reps}
                            onChange={(e) => updateHistorySet(set.index, 'reps', e.target.value)}
                            required
                          />
                        </div>
                        <div style={{ flex: 1 }}>
                          <label className="form-label">Poids (kg)</label>
                          <input
                            type="number"
                            className="form-input"
                            value={set.weight}
                            onChange={(e) => updateHistorySet(set.index, 'weight', e.target.value)}
                            required
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </>
              ) : (
                <>
                  <div className="form-group">
                    <label className="form-label">Nom</label>
                    <input
                      type="text"
                      className="form-input"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      placeholder={
                        type === 'program' ? 'Ex: PPL Split' :
                        type === 'session' ? 'Ex: Push' :
                        'Ex: D√©velopp√© Couch√©'
                      }
                      required
                      autoFocus
                    />
                  </div>

                  {(type === 'exercise' || type === 'edit-exercise') && (
                    <>
                      <div className="form-group">
                        <label className="form-label">Nombre de s√©ries</label>
                        <input
                          type="number"
                          className="form-input"
                          value={formData.sets}
                          onChange={(e) => setFormData({ ...formData, sets: e.target.value })}
                          min="1"
                          max="20"
                          required
                        />
                      </div>

                      <div className="form-group">
                        <label className="form-label">Temps de repos (secondes)</label>
                        <input
                          type="number"
                          className="form-input"
                          value={formData.restTime}
                          onChange={(e) => setFormData({ ...formData, restTime: e.target.value })}
                          min="0"
                          max="600"
                          required
                        />
                      </div>

                      <div className="form-group">
                        <label className="form-label">Notes (optionnel)</label>
                        <textarea
                          className="form-input"
                          value={formData.notes}
                          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                          placeholder="Ex: Utiliser la prise large"
                          rows="3"
                        />
                      </div>
                    </>
                  )}
                </>
              )}

              <button type="submit" className="btn">
                {type === 'edit-exercise' || type === 'edit-history-exercise' ? 'Sauvegarder' : 'Cr√©er'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKCkgPT4gc2VsZi5za2lwV2FpdGluZygpKTs=')
          .catch(() => {});
      });
    }
  </script>
</body>
</html>
